{% extends "note_layout.html" %}
{% block contents %}

<div class="modern-page-container">
    <div class="modern-content-card">
        <div class="modern-card-header">
            <h1>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ¼ãƒˆ</h1>
        </div>
        
        <div class="modern-card-body">
            <!-- Room Info + QR Code -->
            <div class="room-info-container">
                <div class="room-info-card">
                    <div class="room-info-header">Roomæƒ…å ±</div>
                    <div class="room-info-body">
                        <div class="room-info-row">
                            <span class="room-info-label">ID</span>
                            <span class="room-info-value">{{ user_id }}</span>
                        </div>
                        <div class="room-info-row">
                            <span class="room-info-label">Password</span>
                            <span class="room-info-value">{{ password }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="qr-code-container">
                    <img src="https://api.qrserver.com/v1/create-qr-code?size=200x200&data={{ url_for('note.note_room', room_id=room_id, _external=True)|urlencode }}"
                         alt="QR Code" style="width: 160px; height: 160px;">
                </div>
            </div>

            <!-- Editor -->
            <div class="modern-form-group">
                <label for="editor" class="modern-form-label">å…±æœ‰ãƒãƒ¼ãƒˆï¼ˆæœ€å¤§5000æ–‡å­—ï¼‰</label>
                <textarea id="editor" class="modern-editor"
                          placeholder="ã“ã“ã«å…¥åŠ›ã™ã‚‹ã¨1ç§’ã”ã¨ã«åŒæœŸã•ã‚Œã¾ã™â€¦"
                          maxlength="5000" style="height: 60vh;"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                    <small style="color: var(--text-medium);">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åŒæœŸãƒ»ä¿å­˜ã•ã‚Œã¾ã™</small>
                    <span id="status" class="badge bg-secondary" style="padding: 0.5rem 1rem; border-radius: 20px;">Syncingâ€¦</span>
                </div>
            </div>
        </div>
    </div>


<div class="usage-section">
  <div class="usage-section-header">
    <h5>ä½¿ã„æ–¹</h5>
  </div>
  <div class="usage-section-content">
    <p>
      ã“ã®ãƒ«ãƒ¼ãƒ ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å…±æœ‰ã§ãã¾ã™ã€‚<br>
      ä¸Šè¨˜ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã¾ãŸã¯QRã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã™ã‚‹ã¨ä»–ã®å‚åŠ è€…ã‚‚åŒã˜ãƒãƒ¼ãƒˆã‚’ç·¨é›†ã§ãã¾ã™ã€‚<br>
      ã‚¨ãƒ‡ã‚£ã‚¿ã«å…¥åŠ›ã™ã‚‹ã¨1ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ãƒ»åŒæœŸã•ã‚Œã€å¤‰æ›´ã¯ã™ãã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
      æœ€å¤§5000æ–‡å­—ã¾ã§å…¥åŠ›å¯èƒ½ã§ã™ã€‚
    </p>
  </div>
</div>

<script>
  const room   = "{{ room_id }}";
  const editor = document.getElementById("editor");
  const status = document.getElementById("status");
  let lastStamp = "", selfEdit = false;
  let contentAtLastSync = "";  // <--- è¿½åŠ : æœ€å¾Œã«åŒæœŸã—ãŸæ™‚ç‚¹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„

  /* æœ€å¤§æ–‡å­—æ•°ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã¨åˆã‚ã›ã‚‹ã“ã¨ï¼‰ */
  const MAX_LENGTH = 5000;  // è¿½åŠ : ãƒ•ãƒ­ãƒ³ãƒˆå´ã®æœ€å¤§æ–‡å­—æ•°

  /* åˆå›ãƒ­ãƒ¼ãƒ‰ */
  fetch(`/api/note/${room}`).then(r => r.json()).then(j => {
    editor.value = j.content;
    contentAtLastSync = j.content;  // <--- è¿½åŠ 
    lastStamp = j.updated_at;
    status.className = "badge bg-success";
    status.textContent = "Up-to-date";
  });

  /* å…¥åŠ›â†’POST(300ms) */
  let typTimer;
  editor.addEventListener("input", () => {
    clearTimeout(typTimer);
    typTimer = setTimeout(() => {
      const currentContent = editor.value;

      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
      // è¿½åŠ : ãƒ•ãƒ­ãƒ³ãƒˆå´ã§æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯ã€‚è¶…éã—ã¦ã„ãŸã‚‰é€ä¿¡ã›ãšã«ã‚¢ãƒ©ãƒ¼ãƒˆã‚’è¡¨ç¤ºã€‚
      if (currentContent.length > MAX_LENGTH) {
        alert(`æ–‡å­—æ•°ã¯æœ€å¤§ ${MAX_LENGTH} æ–‡å­—ã¾ã§ã§ã™ã€‚ç¾åœ¨ ${currentContent.length} æ–‡å­—ã§ã™ã€‚`);
        // æ–‡å­—æ•°åˆ¶é™ã‚’è¶…ãˆãŸçŠ¶æ…‹ã§ã‚‚å…¥åŠ›è‡ªä½“ã¯ã§ãã¦ã—ã¾ã†ã®ã§ã€
        // ã“ã“ã§é€ä¿¡ã‚’ä¸­æ–­ã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ³¨æ„ã‚’ä¿ƒã™ã ã‘ã«ç•™ã‚ã‚‹ã€‚
        return;
      }
      // â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

      selfEdit = true;
      fetch(`/api/note/${room}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          content: currentContent,
          last_known_updated_at: lastStamp,      // <--- è¿½åŠ 
          original_content: contentAtLastSync   // <--- è¿½åŠ 
        })
      })
      .then(r => {
        if (!r.ok) {
          // ã‚µãƒ¼ãƒãƒ¼å´ã§ 400 ã‚¨ãƒ©ãƒ¼ãªã©ãŒè¿”ã£ã¦ããŸå ´åˆã€
          // JSON ã‚’ãƒ‘ãƒ¼ã‚¹ã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
          return r.json().then(err => {
            throw new Error(err.error || "Save error");
          });
        }
        return r.json();
      })
      .then(j => {
        if (j.status && (j.status.startsWith("ok") || j.status.startsWith("conflict"))) {
          lastStamp = j.updated_at;
          if (j.content !== undefined && editor.value !== j.content) {
            // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒˆãŒè¿”ã•ã‚ŒãŸå ´åˆ (ãƒãƒ¼ã‚¸çµæœã‚„ç«¶åˆæ™‚ã®ã‚µãƒ¼ãƒæœ€æ–°ç‰ˆ)
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¿å­˜
            const cursorStart = editor.selectionStart;
            const cursorEnd = editor.selectionEnd;
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
            editor.value = j.content;
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒï¼ˆæ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é•·ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«èª¿æ•´ï¼‰
            const newLength = j.content.length;
            const adjustedStart = Math.min(cursorStart, newLength);
            const adjustedEnd = Math.min(cursorEnd, newLength);
            editor.setSelectionRange(adjustedStart, adjustedEnd);
          }
          contentAtLastSync = editor.value;  // <--- æ›´æ–°: POSTæˆåŠŸæ™‚ã‚‚æ›´æ–°
          status.className = "badge bg-info";
          status.textContent = "Saved";
          if (j.status === "ok_merged") {
            status.textContent = "Saved (Merged)";
          } else if (j.status === "conflict_merge_failed" || j.status === "conflict_during_merge_save" || j.status === "conflict") {
            status.className = "badge bg-danger";
            status.textContent = "Conflict, please review";
          }
        } else if (j.error) {
          status.className = "badge bg-danger";
          status.textContent = j.error;  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ã‚¨ãƒ©ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        }
        selfEdit = false;
      })
      .catch(err => {
        // ãƒ•ã‚§ãƒƒãƒå¤±æ•—ã‚„ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿæ™‚
        status.className = "badge bg-danger";
        status.textContent = err.message || "Save error (network)";
        selfEdit = false;
      });
    }, 300);
  });

  /* 1 ç§’ãƒãƒ¼ãƒªãƒ³ã‚° */
  setInterval(() => {
    if (selfEdit) return;  // è‡ªåˆ†ç·¨é›†ä¸­ã¯ãƒãƒ¼ãƒªãƒ³ã‚°ã—ãªã„
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const isEditorFocused = document.activeElement === editor;
    
    fetch(`/api/note/${room}`).then(r => r.json()).then(j => {
      if (j.updated_at !== lastStamp) {
        if (!selfEdit) {
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã‚‹å ´åˆã€ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¿å­˜
          let cursorStart = 0;
          let cursorEnd = 0;
          if (isEditorFocused) {
            cursorStart = editor.selectionStart;
            cursorEnd = editor.selectionEnd;
          }
          
          // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
          editor.value = j.content;
          
          // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ãŸå ´åˆã€ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒ
          if (isEditorFocused) {
            // æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é•·ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
            const newLength = j.content.length;
            cursorStart = Math.min(cursorStart, newLength);
            cursorEnd = Math.min(cursorEnd, newLength);
            
            // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒ
            editor.setSelectionRange(cursorStart, cursorEnd);
            editor.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒ
          }
          
          status.className = "badge bg-warning text-dark";
          status.textContent = "Updated by others";
        }
        lastStamp = j.updated_at;
        contentAtLastSync = j.content;  // <--- æ›´æ–°: ãƒãƒ¼ãƒªãƒ³ã‚°æ™‚ã‚‚æ›´æ–°
      } else {
        // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒåŒã˜ã§ã‚‚å¿µã®ãŸã‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
        if (status.textContent === "Syncingâ€¦" || status.textContent.includes("error") || status.textContent.includes("Conflict")) {
          status.className = "badge bg-success";
          status.textContent = "Up-to-date";
        }
      }
    }).catch(() => {
      status.className = "badge bg-danger";
      status.textContent = "Sync error";
    });
  }, 1000);
</script>
{% endblock %}
