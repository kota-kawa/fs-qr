{% extends "note_layout.html" %}

{% block page_title %}ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ  {{ room_id }} | FS!QR Note - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†{% endblock %}

{% block meta_description %}FS!QR Noteã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ ã€‚è¤‡æ•°äººã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’åŒæ™‚ç·¨é›†ãƒ»å…±æœ‰ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ†ã‚­ã‚¹ãƒˆãŒåŒæœŸã•ã‚Œã‚‹å”æ¥­ãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ã€‚{% endblock %}

{% block meta_keywords %}ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ , ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†, ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ¼ãƒˆ, åŒæ™‚ç·¨é›†, å”æ¥­ãƒ„ãƒ¼ãƒ«, å…±æœ‰ãƒãƒ¼ãƒˆ, FS QR Note{% endblock %}

{% block og_title %}ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ  {{ room_id }} | FS!QR Note - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†{% endblock %}

{% block og_description %}FS!QR Noteã®ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ ã€‚è¤‡æ•°äººã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’åŒæ™‚ç·¨é›†ãƒ»å…±æœ‰ã€‚ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§ãƒ†ã‚­ã‚¹ãƒˆãŒåŒæœŸã•ã‚Œã‚‹å”æ¥­ãƒãƒ¼ãƒˆãƒ„ãƒ¼ãƒ«ã€‚{% endblock %}

{% block twitter_title %}ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ  {{ room_id }} | FS!QR Note{% endblock %}

{% block twitter_description %}ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ å…±åŒç·¨é›†ãƒãƒ¼ãƒˆãƒ«ãƒ¼ãƒ ã€‚è¤‡æ•°äººã§ã‚ªãƒ³ãƒ©ã‚¤ãƒ³ãƒãƒ¼ãƒˆã‚’åŒæ™‚ç·¨é›†ãƒ»å…±æœ‰ã§ãã¾ã™ã€‚{% endblock %}

{% block contents %}

<style>
/* Override colors for Note room to match create/search pages */
.modern-card-header {
  background: linear-gradient(135deg, rgb(132, 204, 22) 0%, rgb(163, 230, 53) 100%) !important;
}

.room-info-header {
  background: linear-gradient(135deg, rgb(132, 204, 22) 0%, rgb(163, 230, 53) 100%) !important;
}

.usage-section-header {
  background: linear-gradient(135deg, rgb(132, 204, 22) 0%, rgb(163, 230, 53) 100%) !important;
}

.usage-section-header::after {
  border-top-color: rgb(163, 230, 53) !important;
}

.room-info-value.room-info-url {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.room-info-url-link {
  color: inherit;
  text-decoration: none;
  word-break: break-all;
}

.room-info-url-link:hover,
.room-info-url-link:focus {
  color: inherit;
  text-decoration: none;
}

.copy-url-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2.5rem;
  height: 2.5rem;
  padding: 0;
  border-radius: 999px;
  border: none;
  background: linear-gradient(135deg, rgb(132, 204, 22) 0%, rgb(163, 230, 53) 100%);
  color: #fff;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.copy-url-button svg {
  width: 1.25rem;
  height: 1.25rem;
  flex: none;
}

.copy-url-button:hover,
.copy-url-button:focus-visible {
  transform: translateY(-1px);
  box-shadow: 0 10px 15px -8px rgba(132, 204, 22, 0.5);
}

.copy-url-button:active {
  transform: translateY(0);
}

.copy-url-button.copied {
  background: linear-gradient(135deg, #15803d 0%, #22c55e 100%);
}
</style>

<div class="modern-page-container">
    <div class="modern-content-card">
        <div class="modern-card-header">
            <h1>ğŸ“ ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒãƒ¼ãƒˆ</h1>
        </div>
        
        <div class="modern-card-body">
            <!-- Room Info + QR Code -->
            <div class="room-info-container">
                <div class="room-info-card">
                    <div class="room-info-header">Roomæƒ…å ±</div>
                    <div class="room-info-body">
                        <div class="room-info-row">
                            <span class="room-info-label">Room ID</span>
                            <span class="room-info-value">{{ room_id }}</span>
                        </div>
                        <div class="room-info-row">
                            <span class="room-info-label">Password</span>
                            <span class="room-info-value">{{ password }}</span>
                        </div>
                        <div class="room-info-row">
                            <span class="room-info-label">URL</span>
                            <span class="room-info-value room-info-url">
                                <a id="noteRoomUrl" class="room-info-url-link" href="{{ url_for('note.note_room', room_id=room_id, password=password, _external=True) }}" target="_blank" rel="noopener">
                                    {{ url_for('note.note_room', room_id=room_id, password=password, _external=True) }}
                                </a>
                                <button
                                  type="button"
                                  class="copy-url-button"
                                  data-copy-target="noteRoomUrl"
                                  data-default-label="URLã‚’ã‚³ãƒ”ãƒ¼"
                                  data-copied-label="ã‚³ãƒ”ãƒ¼æ¸ˆã¿"
                                  aria-label="URLã‚’ã‚³ãƒ”ãƒ¼"
                                  title="URLã‚’ã‚³ãƒ”ãƒ¼"
                                >
                                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                                    <path fill="currentColor" d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm4 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h12v14Z"/>
                                  </svg>
                                </button>
                            </span>
                        </div>
                        <div class="room-info-row">
                            <span class="room-info-label">å‰Šé™¤äºˆå®šæ—¥</span>
                            <span class="room-info-value">
                                {% if deletion_date %}
                                    {{ deletion_date }} ï¼ˆ{{ retention_days }}æ—¥å¾Œï¼‰
                                {% else %}
                                    {{ retention_days }}æ—¥å¾Œã«è‡ªå‹•å‰Šé™¤
                                {% endif %}
                            </span>
                        </div>
                    </div>
                </div>
                
                <div class="qr-code-container">
                    <img src="https://api.qrserver.com/v1/create-qr-code?size=200x200&data={{ url_for('note.note_room', room_id=room_id, password=password, _external=True)|urlencode }}"
                         alt="QR Code" style="width: 160px; height: 160px;">
                </div>
            </div>

            <!-- Editor -->
            <div class="modern-form-group">
                <label for="editor" class="modern-form-label">å…±æœ‰ãƒãƒ¼ãƒˆï¼ˆæœ€å¤§5000æ–‡å­—ï¼‰</label>
                <textarea id="editor" class="modern-editor"
                          placeholder="ã“ã“ã«å…¥åŠ›ã™ã‚‹ã¨1ç§’ã”ã¨ã«åŒæœŸã•ã‚Œã¾ã™â€¦"
                          maxlength="5000" style="height: 60vh;"></textarea>
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 0.5rem;">
                    <small style="color: var(--text-medium);">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§åŒæœŸãƒ»ä¿å­˜ã•ã‚Œã¾ã™</small>
                    <span id="status" class="badge bg-secondary" style="padding: 0.5rem 1rem; border-radius: 20px;">Syncingâ€¦</span>
                </div>
            </div>
        </div>
    </div>


<div class="usage-section">
  <div class="usage-section-header">
    <h5>ä½¿ã„æ–¹</h5>
  </div>
  <div class="usage-section-content">
    <p>
      ã“ã®ãƒ«ãƒ¼ãƒ ã§ã¯ãƒ†ã‚­ã‚¹ãƒˆã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å…±æœ‰ã§ãã¾ã™ã€‚<br>
      ä¸Šè¨˜ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€URLã€ã¾ãŸã¯QRã‚³ãƒ¼ãƒ‰ã‚’å…±æœ‰ã™ã‚‹ã¨ä»–ã®å‚åŠ è€…ã‚‚åŒã˜ãƒãƒ¼ãƒˆã‚’ç·¨é›†ã§ãã¾ã™ã€‚<br>
      ã‚¨ãƒ‡ã‚£ã‚¿ã«å…¥åŠ›ã™ã‚‹ã¨1ç§’ã”ã¨ã«è‡ªå‹•ä¿å­˜ãƒ»åŒæœŸã•ã‚Œã€å¤‰æ›´ã¯ã™ãã«åæ˜ ã•ã‚Œã¾ã™ã€‚<br>
      æœ€å¤§5000æ–‡å­—ã¾ã§å…¥åŠ›å¯èƒ½ã§ã™ã€‚
    </p>
  </div>
</div>

<script>
  async function copyTextToClipboard(text) {
    if (navigator.clipboard && window.isSecureContext) {
      return navigator.clipboard.writeText(text);
    }

    return new Promise((resolve, reject) => {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.style.position = 'fixed';
      textarea.style.opacity = '0';
      document.body.appendChild(textarea);
      textarea.focus();
      textarea.select();

      try {
        if (document.execCommand('copy')) {
          resolve();
        } else {
          reject(new Error('execCommand failed'));
        }
      } catch (err) {
        reject(err);
      } finally {
        document.body.removeChild(textarea);
      }
    });
  }

  document.addEventListener('DOMContentLoaded', function () {
    document.querySelectorAll('.copy-url-button').forEach((button) => {
      button.addEventListener('click', async () => {
        const targetId = button.getAttribute('data-copy-target');
        const target = targetId ? document.getElementById(targetId) : null;
        if (!target) {
          return;
        }

        const text = target.textContent.trim();
        const defaultLabel = button.getAttribute('data-default-label') || 'ã‚³ãƒ”ãƒ¼';
        const copiedLabel = button.getAttribute('data-copied-label') || 'ã‚³ãƒ”ãƒ¼æ¸ˆã¿';
        if (!button.hasAttribute('aria-label')) {
          button.setAttribute('aria-label', defaultLabel);
        }
        if (!button.hasAttribute('title')) {
          button.setAttribute('title', defaultLabel);
        }

        try {
          await copyTextToClipboard(text);
          button.classList.add('copied');
          button.setAttribute('aria-label', copiedLabel);
          button.setAttribute('title', copiedLabel);
          setTimeout(() => {
            button.classList.remove('copied');
            button.setAttribute('aria-label', defaultLabel);
            button.setAttribute('title', defaultLabel);
          }, 2000);
        } catch (error) {
          alert('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸã€‚URLã‚’é¸æŠã—ã¦æ‰‹å‹•ã§ã‚³ãƒ”ãƒ¼ã—ã¦ãã ã•ã„ã€‚');
        }
      });
    });
  });
</script>
<script>
  const room   = "{{ room_id }}";
  const roomPassword = "{{ password }}";
  const editor = document.getElementById("editor");
  const status = document.getElementById("status");
  let lastStamp = "", selfEdit = false;
  let contentAtLastSync = "";  // <--- è¿½åŠ : æœ€å¾Œã«åŒæœŸã—ãŸæ™‚ç‚¹ã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
  let selfEditTimeout = null; // selfEdit ãƒ•ãƒ©ã‚°ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç®¡ç†

  /* æœ€å¤§æ–‡å­—æ•°ï¼ˆã‚µãƒ¼ãƒãƒ¼å´ã¨åˆã‚ã›ã‚‹ã“ã¨ï¼‰ */
  const MAX_LENGTH = 5000;  // è¿½åŠ : ãƒ•ãƒ­ãƒ³ãƒˆå´ã®æœ€å¤§æ–‡å­—æ•°
  
  // selfEdit ãƒ•ãƒ©ã‚°ã®å®‰å…¨ãªè¨­å®šé–¢æ•°
  function setSelfEdit(value, timeoutMs = 8000) {
    selfEdit = value;
    
    if (selfEditTimeout) {
      clearTimeout(selfEditTimeout);
      selfEditTimeout = null;
    }
    
    if (value && timeoutMs > 0) {
      // selfEdit ãŒé•·æ™‚é–“ true ã®ã¾ã¾ã«ãªã‚‰ãªã„ã‚ˆã†å®‰å…¨è£…ç½®
      selfEditTimeout = setTimeout(() => {
        if (selfEdit) {
          console.warn("selfEdit flag was stuck, resetting");
          selfEdit = false;
          status.className = "badge bg-warning";
          status.textContent = "Connection timeout";
        }
      }, timeoutMs);
    }
  }

  // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒå®‰å…¨ã«å¾©å…ƒã§ãã‚‹ã‹ãƒã‚§ãƒƒã‚¯ã™ã‚‹é–¢æ•°
  function isCursorSafeToRestore(oldContent, newContent, cursorStart, cursorEnd) {
    // åŸºæœ¬çš„ãªå®‰å…¨ãƒã‚§ãƒƒã‚¯
    if (cursorStart < 0 || cursorEnd < 0 || cursorStart > cursorEnd) {
      return false;
    }
    
    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é•·ã•ãŒå¤§å¹…ã«å¤‰ã‚ã£ãŸå ´åˆã¯å¾©å…ƒã—ãªã„
    const lengthDiff = Math.abs(newContent.length - oldContent.length);
    const relativeDiff = lengthDiff / Math.max(oldContent.length, 1);
    if (relativeDiff > 0.3) { // 30%ä»¥ä¸Šã®å¤‰åŒ–ã¯å¾©å…ƒã—ãªã„
      return false;
    }
    
    // ã‚«ãƒ¼ã‚½ãƒ«å‘¨è¾ºã®ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ãŒå¤‰æ›´ã•ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const contextRange = 50; // ã‚«ãƒ¼ã‚½ãƒ«å‰å¾Œ50æ–‡å­—ã®ç¯„å›²ã‚’ãƒã‚§ãƒƒã‚¯
    const contextStart = Math.max(0, cursorStart - contextRange);
    const contextEnd = Math.min(oldContent.length, cursorEnd + contextRange);
    
    const oldContext = oldContent.substring(contextStart, contextEnd);
    const newContextEnd = Math.min(newContent.length, contextEnd);
    const newContext = newContent.substring(contextStart, newContextEnd);
    
    // ã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆãŒå¤§å¹…ã«å¤‰æ›´ã•ã‚Œã¦ã„ã‚‹å ´åˆã¯å¾©å…ƒã—ãªã„
    return oldContext === newContext || lengthDiff < 10;
  }

  /* åˆå›ãƒ­ãƒ¼ãƒ‰ */
  fetch(`/api/note/${room}/${roomPassword}`).then(r => r.json()).then(j => {
    editor.value = j.content;
    contentAtLastSync = j.content;  // <--- è¿½åŠ 
    lastStamp = j.updated_at;
    status.className = "badge bg-success";
    status.textContent = "Up-to-date";
  });

  /* å…¥åŠ›â†’POST(500ms) - æ”¹å–„: ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ™‚é–“ã‚’å»¶é•·ã—ã¦ã‚³ãƒ³ãƒ•ãƒªã‚¯ãƒˆå‰Šæ¸› */
  let typTimer;
  let saveRetryTimer;
  let retryCount = 0;
  const MAX_RETRIES = 3;
  
  // ä¿å­˜å‡¦ç†ã‚’å®Ÿè¡Œã™ã‚‹é–¢æ•°ï¼ˆãƒªãƒˆãƒ©ã‚¤æ©Ÿèƒ½ä»˜ãï¼‰
  function performSave(currentContent, isRetry = false) {
    // æ–‡å­—æ•°ãƒã‚§ãƒƒã‚¯
    if (currentContent.length > MAX_LENGTH) {
      alert(`æ–‡å­—æ•°ã¯æœ€å¤§ ${MAX_LENGTH} æ–‡å­—ã¾ã§ã§ã™ã€‚ç¾åœ¨ ${currentContent.length} æ–‡å­—ã§ã™ã€‚`);
      setSelfEdit(false);
      return;
    }

    // å¤‰æ›´ãŒãªã„å ´åˆã¯ä¿å­˜ã‚’ã‚¹ã‚­ãƒƒãƒ—
    if (currentContent === contentAtLastSync) {
      setSelfEdit(false);
      return;
    }

    if (!isRetry) {
      retryCount = 0;
      setSelfEdit(true, 12000); // 12ç§’ã®ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆè¨­å®šï¼ˆçŸ­ç¸®ï¼‰
      status.className = "badge bg-secondary";
      status.textContent = "Saving...";
    }

    fetch(`/api/note/${room}/${roomPassword}`, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({
        content: currentContent,
        last_known_updated_at: lastStamp,
        original_content: contentAtLastSync
      })
    })
    .then(r => {
      if (!r.ok) {
        return r.json().then(err => {
          throw new Error(err.error || "Save error");
        });
      }
      return r.json();
    })
    .then(j => {
      retryCount = 0; // æˆåŠŸã—ãŸã‚‰ãƒªãƒˆãƒ©ã‚¤ã‚«ã‚¦ãƒ³ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
      
      if (j.status && (j.status.startsWith("ok") || j.status.startsWith("conflict"))) {
        lastStamp = j.updated_at;
        if (j.content !== undefined && editor.value !== j.content) {
          // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒˆãŒè¿”ã•ã‚ŒãŸå ´åˆã®æ”¹å–„ã•ã‚ŒãŸã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ä¿æŒå‡¦ç†
          const cursorStart = editor.selectionStart;
          const cursorEnd = editor.selectionEnd;
          const isEditorFocused = document.activeElement === editor;
          const oldContent = editor.value;
          
          editor.value = j.content;
          
          // ã‚¨ãƒ‡ã‚£ã‚¿ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ãŒã‚ã‚Šã€ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ãŒå®‰å…¨ã«å¾©å…ƒã§ãã‚‹å ´åˆã®ã¿å¾©å…ƒ
          if (isEditorFocused && isCursorSafeToRestore(oldContent, j.content, cursorStart, cursorEnd)) {
            const newLength = j.content.length;
            const adjustedStart = Math.min(cursorStart, newLength);
            const adjustedEnd = Math.min(cursorEnd, newLength);
            editor.setSelectionRange(adjustedStart, adjustedEnd);
          }
        }
        contentAtLastSync = editor.value;
        
        status.className = "badge bg-success";
        status.textContent = "Saved";
        if (j.status === "ok_merged") {
          status.className = "badge bg-info";
          status.textContent = "Saved (Merged)";
        } else if (j.status === "conflict_merge_failed" || j.status === "conflict_during_merge_save" || j.status === "conflict") {
          status.className = "badge bg-warning text-dark";
          status.textContent = "Conflict resolved";
        }
      } else if (j.error) {
        status.className = "badge bg-danger";
        status.textContent = j.error;
      }
      setSelfEdit(false);
    })
    .catch(err => {
      // ã‚¨ãƒ©ãƒ¼æ™‚ã®ãƒªãƒˆãƒ©ã‚¤å‡¦ç†
      if (retryCount < MAX_RETRIES && !err.message.includes("exceeds max length")) {
        retryCount++;
        status.className = "badge bg-warning";
        status.textContent = `Retrying... (${retryCount}/${MAX_RETRIES})`;
        
        // æŒ‡æ•°ãƒãƒƒã‚¯ã‚ªãƒ•ã§ãƒªãƒˆãƒ©ã‚¤
        const retryDelay = Math.min(1000 * Math.pow(2, retryCount - 1), 5000);
        saveRetryTimer = setTimeout(() => {
          performSave(currentContent, true);
        }, retryDelay);
      } else {
        status.className = "badge bg-danger";
        status.textContent = err.message || "Save failed";
        setSelfEdit(false);
      }
    });
  }

  editor.addEventListener("input", () => {
    clearTimeout(typTimer);
    clearTimeout(saveRetryTimer); // æ—¢å­˜ã®ãƒªãƒˆãƒ©ã‚¤ã‚’ã‚­ãƒ£ãƒ³ã‚»ãƒ«
    
    typTimer = setTimeout(() => {
      const currentContent = editor.value;
      performSave(currentContent);
    }, 800); // ãƒ‡ãƒã‚¦ãƒ³ã‚¹æ™‚é–“ã‚’800msã«å»¶é•·ï¼ˆç«¶åˆã‚’æ›´ã«å‰Šæ¸›ï¼‰
  });

  /* é©å¿œçš„ãƒãƒ¼ãƒªãƒ³ã‚° - ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ç·¨é›†ä¸­ã¯é »åº¦ã‚’ä¸‹ã’ã‚‹ */
  let lastActivity = Date.now();
  let pollingInterval = 1500; // åŸºæœ¬ãƒãƒ¼ãƒªãƒ³ã‚°é–“éš”ã‚’å°‘ã—é•·ã
  let lastPollingTime = Date.now();
  
  // ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£æ¤œå‡ºã®ãŸã‚ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
  editor.addEventListener("focus", () => {
    lastActivity = Date.now();
  });
  
  editor.addEventListener("keydown", () => {
    lastActivity = Date.now();
  });
  
  // ãƒã‚¦ã‚¹ã‚¯ãƒªãƒƒã‚¯ã‚‚ã‚¢ã‚¯ãƒ†ã‚£ãƒ“ãƒ†ã‚£ã¨ã—ã¦æ¤œå‡º
  editor.addEventListener("click", () => {
    lastActivity = Date.now();
  });
  
  function adaptivePolling() {
    const now = Date.now();
    const timeSinceActivity = now - lastActivity;
    const timeSinceLastPoll = now - lastPollingTime;
    
    // æœ€è¿‘ç·¨é›†æ´»å‹•ãŒã‚ã£ãŸå ´åˆã¯ãƒãƒ¼ãƒªãƒ³ã‚°é »åº¦ã‚’ä¸‹ã’ã‚‹
    if (timeSinceActivity < 7000) { // 7ç§’ä»¥å†…ã«æ´»å‹•ãŒã‚ã£ãŸï¼ˆå»¶é•·ï¼‰
      pollingInterval = 3000; // 3ç§’é–“éš”ã«å»¶é•·
    } else if (timeSinceActivity < 15000) { // 15ç§’ä»¥å†…
      pollingInterval = 2000; // 2ç§’é–“éš”
    } else {
      pollingInterval = 1500; // é€šå¸¸ã®1.5ç§’é–“éš”
    }
    
    // ãƒãƒ¼ãƒªãƒ³ã‚°å®Ÿè¡Œã®åˆ¤å®š
    if (timeSinceLastPoll >= pollingInterval) {
      lastPollingTime = now;
      performPolling();
    }
    
    // æ¬¡å›ãƒãƒ¼ãƒªãƒ³ã‚°äºˆç´„ï¼ˆ150msé–“éš”ã§ãƒã‚§ãƒƒã‚¯ã€è² è·è»½æ¸›ï¼‰
    setTimeout(adaptivePolling, 150);
  }
  
  function performPolling() {
    if (selfEdit) return; // è‡ªåˆ†ç·¨é›†ä¸­ã¯ãƒãƒ¼ãƒªãƒ³ã‚°ã—ãªã„
    
    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒç¾åœ¨ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
    const isEditorFocused = document.activeElement === editor;
    
    fetch(`/api/note/${room}/${roomPassword}`)
      .then(r => r.json())
      .then(j => {
        if (j.updated_at !== lastStamp) {
          if (!selfEdit) {
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¨ãƒ‡ã‚£ã‚¿ãƒ¼ã«ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã‚‹å ´åˆã€ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’ä¿å­˜
            let cursorStart = 0;
            let cursorEnd = 0;
            const oldContent = editor.value;
            
            if (isEditorFocused) {
              cursorStart = editor.selectionStart;
              cursorEnd = editor.selectionEnd;
            }
            
            // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚’æ›´æ–°
            editor.value = j.content;
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã—ã¦ã„ã¦ã€å®‰å…¨ã«å¾©å…ƒã§ãã‚‹å ´åˆã®ã¿ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒ
            if (isEditorFocused && isCursorSafeToRestore(oldContent, j.content, cursorStart, cursorEnd)) {
              // æ–°ã—ã„ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã®é•·ã•ã‚’è¶…ãˆãªã„ã‚ˆã†ã«ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’èª¿æ•´
              const newLength = j.content.length;
              cursorStart = Math.min(cursorStart, newLength);
              cursorEnd = Math.min(cursorEnd, newLength);
              
              // ã‚«ãƒ¼ã‚½ãƒ«ä½ç½®ã‚’å¾©å…ƒ
              editor.setSelectionRange(cursorStart, cursorEnd);
              editor.focus(); // ãƒ•ã‚©ãƒ¼ã‚«ã‚¹ã‚’ç¶­æŒ
            }
            
            status.className = "badge bg-warning text-dark";
            status.textContent = "Updated by others";
          }
          lastStamp = j.updated_at;
          contentAtLastSync = j.content;
        } else {
          // ã‚¿ã‚¤ãƒ ã‚¹ã‚¿ãƒ³ãƒ—ãŒåŒã˜ã§ã‚‚å¿µã®ãŸã‚ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹ã‚’æ›´æ–°
          if (status.textContent === "Syncingâ€¦" || status.textContent.includes("error") || status.textContent.includes("Conflict")) {
            status.className = "badge bg-success";
            status.textContent = "Up-to-date";
          }
        }
      })
      .catch(() => {
        status.className = "badge bg-danger";
        status.textContent = "Sync error";
      });
  }
  
  // é©å¿œçš„ãƒãƒ¼ãƒªãƒ³ã‚°é–‹å§‹
  adaptivePolling();
</script>
{% endblock %}
