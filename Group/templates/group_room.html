{% extends "group_layout.html" %}
{% block contents %}

<style>
/* Override colors for Group room to match create/search pages */
.modern-card-header {
  background: linear-gradient(135deg, rgb(22, 101, 52) 0%, rgb(34, 197, 94) 100%) !important;
}

.room-info-header {
  background: linear-gradient(135deg, rgb(22, 101, 52) 0%, rgb(34, 197, 94) 100%) !important;
}

.usage-section-header {
  background: linear-gradient(135deg, rgb(22, 101, 52) 0%, rgb(34, 197, 94) 100%) !important;
}

.usage-section-header::after {
  border-top-color: rgb(34, 197, 94) !important;
}
</style>

<div class="modern-page-container">
    <div class="modern-content-card">
        <div class="modern-card-header">
            <h1>ğŸ“‚ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰</h1>
        </div>
        
        <div class="modern-card-body">
            <!-- Room Info + QR Code -->
            <div class="room-info-container">
                <div class="room-info-card">
                    <div class="room-info-header">Roomæƒ…å ±</div>
                    <div class="room-info-body">
                        <div class="room-info-row">
                            <span class="room-info-label">ID</span>
                            <span class="room-info-value">{{ user_id }}</span>
                        </div>
                        <div class="room-info-row">
                            <span class="room-info-label">Password</span>
                            <span class="room-info-value">{{ password }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="qr-code-container">
                    <img src="https://api.qrserver.com/v1/create-qr-code?size=200x200&data={{ url_for('group.group_direct_access', room_id=room_id, password=password, _external=True) | urlencode }}"
                         alt="Room QR Code" style="width: 160px; height: 160px;">
                </div>
            </div>

            <!-- Upload Area -->
            <div class="modern-upload-area" id="upload-area">
                <div class="upload-icon-modern">â˜ï¸</div>
                <p class="upload-text-modern">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                <button type="button" class="upload-button-modern" id="uploadFileBtn">
                    ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>

            <!-- Uploaded Files List -->
            <div style="margin: 2rem 0;">
                <h5 style="color: var(--text-dark); margin-bottom: 1rem;">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡ãƒ•ã‚¡ã‚¤ãƒ«</h5>
                <div id="fileList" class="modern-file-list" style="display: none;">
                    <!-- è‡ªåˆ†ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <button class="modern-btn modern-btn-success" id="uploadBtn" style="margin-top: 1rem;">
                    ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </button>
                
                <!-- Upload Progress Bar -->
                <div id="uploadProgressContainer" style="display: none; margin-top: 1rem;">
                    <div style="text-align: center; margin-bottom: 0.5rem; color: var(--text-dark); font-weight: 500;">
                        <span id="uploadProgressText">ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...</span>
                    </div>
                    <div class="progress-bar-container">
                        <div class="progress-bar" id="uploadProgressBar"></div>
                    </div>
                </div>
            </div>

            <!-- Other Users' Files -->
            <div style="margin: 2rem 0;">
                <h5 style="color: var(--text-dark); margin-bottom: 1rem;">
                    ğŸ“¥ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ« (<span id="fileCount">0</span>)
                </h5>
                <div id="otherFileList" class="modern-file-list">
                    <!-- ä»–ã®äººã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <button class="modern-btn" id="downloadAllBtn" style="margin-top: 1rem;">
                    ğŸ“¦ ã™ã¹ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

<!-- Download Progress Spinner -->
<div class="spinner-container" id="downloadSpinnerContainer" style="display: none;">
    <div class="spinner-second-container" id="downloadAnimationContainer">
        <div class="icon file">ğŸ“„</div>
        <div class="icon download">ğŸ“¥</div>
        <div class="text" id="downloadStatusText">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...</div>
        <div class="progress-bar-container">
            <div class="progress-bar" id="downloadProgressBar"></div>
        </div>
    </div>
</div>

<div class="usage-section">
    <div class="usage-section-header">
        <h5>ä½¿ã„æ–¹</h5>
    </div>
    <div class="usage-section-content">
        <p>
            ã“ã®ãƒ«ãƒ¼ãƒ ã§ã¯ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br>
            ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ã—ã€ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§é€ä¿¡ã—ã¾ã™ã€‚<br>
            å…±æœ‰ã—ãŸã„ç›¸æ‰‹ã«ã¯ä¸Šè¨˜ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã¾ãŸã¯QRã‚³ãƒ¼ãƒ‰ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚<br>
            ä»–ã®äººã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰å€‹åˆ¥ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„å‰Šé™¤ãŒã§ãã¾ã™ã€‚
        </p>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function () {
        var uploadArea = $('#upload-area');
        var fileInput = $('#fileInput');
        var fileList = $('#fileList');
        var otherFileList = $('#otherFileList');
        var uploadBtn = $('#uploadBtn');
        var downloadAllBtn = $('#downloadAllBtn');
        var filesArray = [];

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        uploadArea.on('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.addClass('dragover');
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
        uploadArea.on('dragleave', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.removeClass('dragover');
        });

        // ãƒ‰ãƒ­ãƒƒãƒ—
        uploadArea.on('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.removeClass('dragover');
            var files = e.originalEvent.dataTransfer.files;
            handleFiles(files);
        });

        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        uploadArea.on('click', function (e) {
            // ãƒœã‚¿ãƒ³ä»¥å¤–ã®å ´æ‰€ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸå ´åˆã«ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠãƒ€ã‚¤ã‚¢ãƒ­ã‚°ã‚’é–‹ã
            if (e.target.tagName !== 'BUTTON') {
                fileInput[0].click();
            }
        });
        
        // ãƒœã‚¿ãƒ³ã®ç›´æ¥çš„ãªã‚¯ãƒªãƒƒã‚¯ãƒãƒ³ãƒ‰ãƒ©
        $('#uploadFileBtn').on('click', function(e) {
            e.preventDefault();
            e.stopPropagation();
            fileInput[0].click();
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œ
        fileInput.on('change', function () {
            var files = fileInput[0].files;
            handleFiles(files);
        });

        // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
        var fetchRetryCount = 0;
        var maxRetries = 3;
        var isDownloading = {}; // Track download states to prevent multiple clicks
        
        function fetchAndDisplayOtherFiles() {
            var roomId = '{{ room_id }}'; // Jinja2ã§åŸ‹ã‚è¾¼ã‚€
            $.ajax({
                url: `/check/${roomId}`,
                type: 'GET',
                timeout: 10000, // 10 second timeout
                success: function (files) {
                    fetchRetryCount = 0; // Reset retry count on success
                    
                    if (files.error) {
                        console.warn('ãƒ•ã‚¡ã‚¤ãƒ«å–å¾—ã‚¨ãƒ©ãƒ¼:', files.error);
                        return;
                    }

                    otherFileList.empty(); // ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    $('#fileCount').text(files.length); // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’æ›´æ–°
                    
                    if (files.length === 0) {
                        otherFileList.html('<div style="text-align: center; padding: 2rem; color: var(--text-medium);">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>');
                        return;
                    }
                    
                    files.forEach(function (file) {
                        var fileItem = $('<div class="modern-file-item"></div>');
                        var fileName = $('<div class="modern-file-name"></div>');
                        var fileNameText = $('<span class="modern-file-name-text"></span>').text(file.name);
                        fileName.html('<span class="modern-file-icon">ğŸ“„</span>').append(fileNameText);
                        
                        var actions = $('<div class="modern-file-actions"></div>');

                        var downloadBtn = $('<button class="modern-file-action-btn">ğŸ“¥</button>');
                        const encodedFilename = encodeURIComponent(file.name);
                        const downloadKey = `${roomId}-${file.name}`;
                        
                        downloadBtn.on('click', function (e) {
                            e.preventDefault();
                            e.stopPropagation();
                            
                            // Prevent multiple simultaneous downloads of the same file
                            if (isDownloading[downloadKey]) {
                                return;
                            }
                            
                            isDownloading[downloadKey] = true;
                            downloadBtn.prop('disabled', true);
                            
                            // Show download progress spinner
                            $('#downloadSpinnerContainer').show();
                            $('#downloadAnimationContainer').addClass('downloading');
                            $('#downloadStatusText').text(`${file.name} ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...`);
                            $('#downloadProgressBar').css('transform', 'scaleX(0)');
                            
                            // Use XMLHttpRequest for progress tracking
                            var xhr = new XMLHttpRequest();
                            xhr.open('GET', `/download/${roomId}/${encodedFilename}`, true);
                            xhr.responseType = 'blob';
                            
                            xhr.onprogress = function(event) {
                                if (event.lengthComputable) {
                                    var percentComplete = event.loaded / event.total;
                                    $('#downloadProgressBar').css('transform', `scaleX(${percentComplete})`);
                                }
                            };
                            
                            xhr.onload = function() {
                                if (xhr.status === 200) {
                                    // Create download link
                                    var blob = xhr.response;
                                    var link = document.createElement('a');
                                    link.href = URL.createObjectURL(blob);
                                    link.download = file.name;
                                    document.body.appendChild(link);
                                    link.click();
                                    document.body.removeChild(link);
                                    URL.revokeObjectURL(link.href);
                                    
                                    $('#downloadProgressBar').css('transform', 'scaleX(1)');
                                    $('#downloadStatusText').text('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼');
                                    
                                    setTimeout(function() {
                                        $('#downloadSpinnerContainer').hide();
                                        $('#downloadAnimationContainer').removeClass('downloading');
                                    }, 1000);
                                } else {
                                    alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                                    $('#downloadSpinnerContainer').hide();
                                    $('#downloadAnimationContainer').removeClass('downloading');
                                }
                                
                                // Re-enable button
                                isDownloading[downloadKey] = false;
                                downloadBtn.prop('disabled', false);
                            };
                            
                            xhr.onerror = function() {
                                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                                $('#downloadSpinnerContainer').hide();
                                $('#downloadAnimationContainer').removeClass('downloading');
                                isDownloading[downloadKey] = false;
                                downloadBtn.prop('disabled', false);
                            };
                            
                            xhr.send();
                        });

                        var deleteBtn = $('<button class="modern-file-action-btn delete">ğŸ—‘ï¸</button>');
                        deleteBtn.on('click', function () {
                            if (confirm('æœ¬å½“ã«ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                $.ajax({
                                    url: `/delete/${roomId}/${encodedFilename}`,
                                    type: 'DELETE',
                                    success: function () {
                                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                                        fileItem.remove();
                                        $('#fileCount').text($('#otherFileList .modern-file-item').length);
                                    },
                                    error: function () {
                                        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                                    }
                                });
                            }
                        });

                        actions.append(downloadBtn).append(deleteBtn);
                        fileItem.append(fileName).append(actions);
                        otherFileList.append(fileItem);
                    });
                },
                error: function (xhr, status, error) {
                    fetchRetryCount++;
                    console.warn(`ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±å–å¾—å¤±æ•— (è©¦è¡Œ ${fetchRetryCount}/${maxRetries}):`, status, error);
                    
                    // Only show alert after all retries are exhausted
                    if (fetchRetryCount >= maxRetries) {
                        console.error('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                        fetchRetryCount = 0; // Reset for next cycle
                    }
                    // Don't show alert for temporary network issues
                }
            });
        }

        // å®šæœŸçš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function startFilePolling() {
            // Initial load
            fetchAndDisplayOtherFiles();
            // Slightly longer interval to reduce server load and conflicts
            setInterval(fetchAndDisplayOtherFiles, 2000); // 2ç§’ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        }

        startFilePolling();

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFiles(files) {
            // ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯ (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ« + æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«)
            const MAX_FILES = 10;
            const totalFiles = filesArray.length + files.length;
            if (totalFiles > MAX_FILES) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯æœ€å¤§${MAX_FILES}å€‹ã¾ã§ã§ã™ï¼ˆç¾åœ¨: ${filesArray.length}å€‹ã€è¿½åŠ ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: ${files.length}å€‹ï¼‰`);
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ãƒã‚§ãƒƒã‚¯ (50MB = 50 * 1024 * 1024 bytes)
            const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB
            let currentSize = 0;
            let newFilesSize = 0;

            // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            filesArray.forEach(function(file) {
                currentSize += file.size;
            });

            // æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            for (var i = 0; i < files.length; i++) {
                newFilesSize += files[i].size;
            }

            const totalSize = currentSize + newFilesSize;
            if (totalSize > MAX_TOTAL_SIZE) {
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯50MBã¾ã§ã§ã™ï¼ˆç¾åœ¨ã®åˆè¨ˆ: ${totalSizeMB}MBï¼‰`);
                return;
            }

            fileList.show(); // Show file list
            
            for (var i = 0; i < files.length; i++) {
                filesArray.push(files[i]);
                var fileItem = $('<div class="modern-file-item"></div>');
                var fileName = $('<div class="modern-file-name"></div>');
                var fileNameText = $('<span class="modern-file-name-text"></span>').text(files[i].name);
                fileName.html('<span class="modern-file-icon">ğŸ“„</span>').append(fileNameText);
                
                var actions = $('<div class="modern-file-actions"></div>');
                var deleteBtn = $('<button class="modern-file-action-btn delete">ğŸ—‘ï¸</button>');
                deleteBtn.on('click', (function (index) {
                    return function () {
                        filesArray.splice(index, 1);
                        $(this).closest('.modern-file-item').remove();
                        if (filesArray.length === 0) {
                            fileList.hide();
                            document.querySelector('.upload-icon-modern').textContent = 'â˜ï¸';
                        }
                    };
                })(filesArray.length - 1));
                
                actions.append(deleteBtn);
                fileItem.append(fileName).append(actions);
                fileList.append(fileItem);
            }
            
            document.querySelector('.upload-icon-modern').textContent = 'âœ…';
        }

        uploadBtn.on('click', function () {
            if (filesArray.length === 0) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«å†åº¦ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
            const MAX_FILES = 10;
            const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB

            if (filesArray.length > MAX_FILES) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯æœ€å¤§${MAX_FILES}å€‹ã¾ã§ã§ã™`);
                return;
            }

            let totalSize = 0;
            filesArray.forEach(function(file) {
                totalSize += file.size;
            });

            if (totalSize > MAX_TOTAL_SIZE) {
                const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯50MBã¾ã§ã§ã™ï¼ˆç¾åœ¨: ${sizeMB}MBï¼‰`);
                return;
            }

            var formData = new FormData();
            filesArray.forEach(function (file) {
                formData.append('upfile', file);  // `upfile` ã‚­ãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
            });

            let uploadType = '{{ room_id }}'; // Jinja2ã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰å€¤ã‚’åŸ‹ã‚è¾¼ã‚€
            
            // Show progress bar
            $('#uploadProgressContainer').show();
            $('#uploadProgressBar').css('transform', 'scaleX(0)');
            $('#uploadProgressText').text('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

            // Disable upload button during upload
            uploadBtn.prop('disabled', true).text('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...');

            $.ajax({
                url: `/group_upload/${uploadType}`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                xhr: function() {
                    var xhr = new window.XMLHttpRequest();
                    // Upload progress
                    xhr.upload.addEventListener("progress", function(evt) {
                        if (evt.lengthComputable) {
                            var percentComplete = evt.loaded / evt.total;
                            $('#uploadProgressBar').css('transform', `scaleX(${percentComplete})`);
                            $('#uploadProgressText').text(`ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­... ${Math.round(percentComplete * 100)}%`);
                        }
                    }, false);
                    return xhr;
                },
                success: function (response) {
                    $('#uploadProgressBar').css('transform', 'scaleX(1)');
                    $('#uploadProgressText').text('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼');
                    
                    setTimeout(function() {
                        $('#uploadProgressContainer').hide();
                        uploadBtn.prop('disabled', false).text('ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰');
                        
                        if (response.status === 'success') {
                            alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');
                            fileList.empty().hide();
                            filesArray = [];
                            document.querySelector('.upload-icon-modern').textContent = 'â˜ï¸';
                        } else if (response.status === 'error') {
                            alert('ã‚¨ãƒ©ãƒ¼: ' + response.message + '\nå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ' + response.files.join(', '));
                        } else {
                            alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');
                            fileList.empty().hide();
                            filesArray = [];
                            document.querySelector('.upload-icon-modern').textContent = 'â˜ï¸';
                        }
                    }, 1000);
                },
                error: function (xhr) {
                    $('#uploadProgressContainer').hide();
                    uploadBtn.prop('disabled', false).text('ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰');
                    
                    var errorMessage = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert(errorMessage);
                }
            });
        });

        // ã™ã¹ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        var roomId = '{{ room_id }}';
        var isDownloadingAll = false;
        
        downloadAllBtn.on('click', function () {
            if (isDownloadingAll) {
                return;
            }
            
            isDownloadingAll = true;
            downloadAllBtn.prop('disabled', true);
            
            // Show download progress spinner
            $('#downloadSpinnerContainer').show();
            $('#downloadAnimationContainer').addClass('downloading');
            $('#downloadStatusText').text('å…¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­...');
            $('#downloadProgressBar').css('transform', 'scaleX(0)');
            
            // Use XMLHttpRequest for progress tracking
            var xhr = new XMLHttpRequest();
            xhr.open('GET', `/download/all/${roomId}`, true);
            xhr.responseType = 'blob';
            
            xhr.onprogress = function(event) {
                if (event.lengthComputable) {
                    var percentComplete = event.loaded / event.total;
                    $('#downloadProgressBar').css('transform', `scaleX(${percentComplete})`);
                }
            };
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    // Create download link
                    var blob = xhr.response;
                    var link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = `${roomId}_files.zip`;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(link.href);
                    
                    $('#downloadProgressBar').css('transform', 'scaleX(1)');
                    $('#downloadStatusText').text('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å®Œäº†ï¼');
                    
                    setTimeout(function() {
                        $('#downloadSpinnerContainer').hide();
                        $('#downloadAnimationContainer').removeClass('downloading');
                    }, 1000);
                } else {
                    alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                    $('#downloadSpinnerContainer').hide();
                    $('#downloadAnimationContainer').removeClass('downloading');
                }
                
                // Re-enable button
                isDownloadingAll = false;
                downloadAllBtn.prop('disabled', false);
            };
            
            xhr.onerror = function() {
                alert('ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                $('#downloadSpinnerContainer').hide();
                $('#downloadAnimationContainer').removeClass('downloading');
                isDownloadingAll = false;
                downloadAllBtn.prop('disabled', false);
            };
            
            xhr.send();
        });
    });
</script>
{% endblock %}