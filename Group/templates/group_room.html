{% extends "group_layout.html" %}
{% block contents %}

<div class="modern-page-container">
    <div class="modern-content-card">
        <div class="modern-card-header">
            <h1>ğŸ“‚ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰</h1>
        </div>
        
        <div class="modern-card-body">
            <!-- Room Info + QR Code -->
            <div class="room-info-container">
                <div class="room-info-card">
                    <div class="room-info-header">Roomæƒ…å ±</div>
                    <div class="room-info-body">
                        <div class="room-info-row">
                            <span class="room-info-label">ID</span>
                            <span class="room-info-value">{{ user_id }}</span>
                        </div>
                        <div class="room-info-row">
                            <span class="room-info-label">Password</span>
                            <span class="room-info-value">{{ password }}</span>
                        </div>
                    </div>
                </div>
                
                <div class="qr-code-container">
                    <img src="https://api.qrserver.com/v1/create-qr-code?size=200x200&data={{ url_for('group.group_list', room_id=room_id, _external=True) | urlencode }}"
                         alt="Room QR Code" style="width: 160px; height: 160px;">
                </div>
            </div>

            <!-- Upload Area -->
            <div class="modern-upload-area" id="upload-area">
                <div class="upload-icon-modern">â˜ï¸</div>
                <p class="upload-text-modern">ã“ã“ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—<br>ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ</p>
                <button type="button" class="upload-button-modern" onclick="fileInput.click()">
                    ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                </button>
                <input type="file" id="fileInput" multiple style="display: none;">
            </div>

            <!-- Uploaded Files List -->
            <div style="margin: 2rem 0;">
                <h5 style="color: var(--text-dark); margin-bottom: 1rem;">ğŸ“¤ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å¾…ã¡ãƒ•ã‚¡ã‚¤ãƒ«</h5>
                <div id="fileList" class="modern-file-list" style="display: none;">
                    <!-- è‡ªåˆ†ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <button class="modern-btn modern-btn-success" id="uploadBtn" style="margin-top: 1rem;">
                    ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>

            <!-- Other Users' Files -->
            <div style="margin: 2rem 0;">
                <h5 style="color: var(--text-dark); margin-bottom: 1rem;">
                    ğŸ“¥ ã‚°ãƒ«ãƒ¼ãƒ—ãƒ¡ãƒ³ãƒãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ« (<span id="fileCount">0</span>)
                </h5>
                <div id="otherFileList" class="modern-file-list">
                    <!-- ä»–ã®äººã®ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã—ãŸãƒ•ã‚¡ã‚¤ãƒ«ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                </div>
                <button class="modern-btn" id="downloadAllBtn" style="margin-top: 1rem;">
                    ğŸ“¦ ã™ã¹ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                </button>
            </div>
        </div>
    </div>

<div class="usage-section">
    <div class="usage-section-header">
        <h5>ä½¿ã„æ–¹</h5>
    </div>
    <div class="usage-section-content">
        <p>
            ã“ã®ãƒ«ãƒ¼ãƒ ã§ã¯ãƒ¡ãƒ³ãƒãƒ¼å…¨å“¡ãŒãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ï¼ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br>
            ãƒ•ã‚¡ã‚¤ãƒ«ã¯ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã¾ãŸã¯ã‚¯ãƒªãƒƒã‚¯ã§è¿½åŠ ã—ã€ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ãƒœã‚¿ãƒ³ã§é€ä¿¡ã—ã¾ã™ã€‚<br>
            å…±æœ‰ã—ãŸã„ç›¸æ‰‹ã«ã¯ä¸Šè¨˜ã®IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã€ã¾ãŸã¯QRã‚³ãƒ¼ãƒ‰ã‚’æ¸¡ã—ã¦ãã ã•ã„ã€‚<br>
            ä»–ã®äººã®ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸‹ã®ãƒªã‚¹ãƒˆã‹ã‚‰å€‹åˆ¥ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã‚„å‰Šé™¤ãŒã§ãã¾ã™ã€‚
        </p>
    </div>
</div>

<script src="https://code.jquery.com/jquery-3.5.1.min.js"></script>
<script>
    $(document).ready(function () {
        var uploadArea = $('#upload-area');
        var fileInput = $('#fileInput');
        var fileList = $('#fileList');
        var otherFileList = $('#otherFileList');
        var uploadBtn = $('#uploadBtn');
        var downloadAllBtn = $('#downloadAllBtn');
        var filesArray = [];

        // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼
        uploadArea.on('dragover', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.addClass('dragover');
        });

        // ãƒ‰ãƒ©ãƒƒã‚°ãƒªãƒ¼ãƒ–
        uploadArea.on('dragleave', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.removeClass('dragover');
        });

        // ãƒ‰ãƒ­ãƒƒãƒ—
        uploadArea.on('drop', function (e) {
            e.preventDefault();
            e.stopPropagation();
            uploadArea.removeClass('dragover');
            var files = e.originalEvent.dataTransfer.files;
            handleFiles(files);
        });

        // ã‚¯ãƒªãƒƒã‚¯ã§ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠ
        uploadArea.on('click', function (e) {
            // ãƒœã‚¿ãƒ³ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆãŒuploadAreaã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆã«å¹²æ¸‰ã—ãªã„ã‚ˆã†ã«ã™ã‚‹
            if (e.target.tagName !== 'BUTTON') {
                fileInput.click();
            }
        });

        // ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠå¾Œ
        fileInput.on('change', function () {
            var files = fileInput[0].files;
            handleFiles(files);
        });

        // ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«è¡¨ç¤º
        function fetchAndDisplayOtherFiles() {
            var roomId = '{{ room_id }}'; // Jinja2ã§åŸ‹ã‚è¾¼ã‚€
            $.ajax({
                url: `/check/${roomId}`,
                type: 'GET',
                success: function (files) {
                    if (files.error) {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + files.error);
                        return;
                    }

                    otherFileList.empty(); // ãƒªã‚¹ãƒˆã‚’ãƒªã‚»ãƒƒãƒˆ
                    $('#fileCount').text(files.length); // ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’æ›´æ–°
                    
                    if (files.length === 0) {
                        otherFileList.html('<div style="text-align: center; padding: 2rem; color: var(--text-medium);">ã¾ã ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã¾ã›ã‚“</div>');
                        return;
                    }
                    
                    files.forEach(function (file) {
                        var fileItem = $('<div class="modern-file-item"></div>');
                        var fileName = $('<div class="modern-file-name"></div>');
                        fileName.html('<span class="modern-file-icon">ğŸ“„</span>' + file.name);
                        
                        var actions = $('<div class="modern-file-actions"></div>');

                        var downloadBtn = $('<button class="modern-file-action-btn">ğŸ“¥</button>');
                        const encodedFilename = encodeURIComponent(file.name);
                        downloadBtn.on('click', function () {
                            window.location.href = `/download/${roomId}/${encodedFilename}`;
                        });

                        var deleteBtn = $('<button class="modern-file-action-btn delete">ğŸ—‘ï¸</button>');
                        deleteBtn.on('click', function () {
                            if (confirm('æœ¬å½“ã«ã“ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
                                $.ajax({
                                    url: `/delete/${roomId}/${encodedFilename}`,
                                    type: 'DELETE',
                                    success: function () {
                                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒå‰Šé™¤ã•ã‚Œã¾ã—ãŸã€‚');
                                        fileItem.remove();
                                        $('#fileCount').text($('#otherFileList .modern-file-item').length);
                                    },
                                    error: function () {
                                        alert('å‰Šé™¤ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚');
                                    }
                                });
                            }
                        });

                        actions.append(downloadBtn).append(deleteBtn);
                        fileItem.append(fileName).append(actions);
                        otherFileList.append(fileItem);
                    });
                },
                error: function () {
                    alert('ä»–ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚');
                }
            });
        }

        // å®šæœŸçš„ã«ãƒ•ã‚¡ã‚¤ãƒ«ãƒªã‚¹ãƒˆã‚’æ›´æ–°ã™ã‚‹é–¢æ•°
        function startFilePolling() {
            setInterval(fetchAndDisplayOtherFiles, 1000); // 1ç§’ã”ã¨ã«ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‚’é€ä¿¡
        }

        startFilePolling();

        // ãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
        function handleFiles(files) {
            // ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯ (æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ« + æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«)
            const MAX_FILES = 10;
            const totalFiles = filesArray.length + files.length;
            if (totalFiles > MAX_FILES) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯æœ€å¤§${MAX_FILES}å€‹ã¾ã§ã§ã™ï¼ˆç¾åœ¨: ${filesArray.length}å€‹ã€è¿½åŠ ã—ã‚ˆã†ã¨ã—ã¦ã„ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«: ${files.length}å€‹ï¼‰`);
                return;
            }

            // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ãƒã‚§ãƒƒã‚¯ (50MB = 50 * 1024 * 1024 bytes)
            const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB
            let currentSize = 0;
            let newFilesSize = 0;

            // æ—¢å­˜ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            filesArray.forEach(function(file) {
                currentSize += file.size;
            });

            // æ–°è¦ãƒ•ã‚¡ã‚¤ãƒ«ã®ã‚µã‚¤ã‚ºã‚’è¨ˆç®—
            for (var i = 0; i < files.length; i++) {
                newFilesSize += files[i].size;
            }

            const totalSize = currentSize + newFilesSize;
            if (totalSize > MAX_TOTAL_SIZE) {
                const totalSizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯50MBã¾ã§ã§ã™ï¼ˆç¾åœ¨ã®åˆè¨ˆ: ${totalSizeMB}MBï¼‰`);
                return;
            }

            fileList.show(); // Show file list
            
            for (var i = 0; i < files.length; i++) {
                filesArray.push(files[i]);
                var fileItem = $('<div class="modern-file-item"></div>');
                var fileName = $('<div class="modern-file-name"></div>');
                fileName.html('<span class="modern-file-icon">ğŸ“„</span>' + files[i].name);
                
                var actions = $('<div class="modern-file-actions"></div>');
                var deleteBtn = $('<button class="modern-file-action-btn delete">ğŸ—‘ï¸</button>');
                deleteBtn.on('click', (function (index) {
                    return function () {
                        filesArray.splice(index, 1);
                        $(this).closest('.modern-file-item').remove();
                        if (filesArray.length === 0) {
                            fileList.hide();
                            document.querySelector('.upload-icon-modern').textContent = 'â˜ï¸';
                        }
                    };
                })(filesArray.length - 1));
                
                actions.append(deleteBtn);
                fileItem.append(fileName).append(actions);
                fileList.append(fileItem);
            }
            
            document.querySelector('.upload-icon-modern').textContent = 'âœ…';
        }

        uploadBtn.on('click', function () {
            if (filesArray.length === 0) {
                alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚ã‚Šã¾ã›ã‚“ã€‚');
                return;
            }

            // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«å†åº¦ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
            const MAX_FILES = 10;
            const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB

            if (filesArray.length > MAX_FILES) {
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯æœ€å¤§${MAX_FILES}å€‹ã¾ã§ã§ã™`);
                return;
            }

            let totalSize = 0;
            filesArray.forEach(function(file) {
                totalSize += file.size;
            });

            if (totalSize > MAX_TOTAL_SIZE) {
                const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
                alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯50MBã¾ã§ã§ã™ï¼ˆç¾åœ¨: ${sizeMB}MBï¼‰`);
                return;
            }

            var formData = new FormData();
            filesArray.forEach(function (file) {
                formData.append('upfile', file);  // `upfile` ã‚­ãƒ¼ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’è¿½åŠ 
            });

            let uploadType = '{{ room_id }}'; // Jinja2ã§ã‚µãƒ¼ãƒãƒ¼ã‚µã‚¤ãƒ‰ã‹ã‚‰å€¤ã‚’åŸ‹ã‚è¾¼ã‚€

            $.ajax({
                url: `/group_upload/${uploadType}`,
                type: 'POST',
                data: formData,
                processData: false,
                contentType: false,
                success: function (response) {
                    if (response.status === 'success') {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');
                        fileList.empty().hide();
                        filesArray = [];
                        document.querySelector('.upload-icon-modern').textContent = 'â˜ï¸';
                    } else if (response.status === 'error') {
                        alert('ã‚¨ãƒ©ãƒ¼: ' + response.message + '\nå¯¾è±¡ãƒ•ã‚¡ã‚¤ãƒ«: ' + response.files.join(', '));
                    } else {
                        alert('ãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¾ã—ãŸã€‚');
                        fileList.empty().hide();
                        filesArray = [];
                        document.querySelector('.upload-icon-modern').textContent = 'â˜ï¸';
                    }
                },
                error: function (xhr) {
                    var errorMessage = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸã€‚';
                    if (xhr.responseJSON && xhr.responseJSON.error) {
                        errorMessage = xhr.responseJSON.error;
                    }
                    alert(errorMessage);
                }
            });
        });

        // ã™ã¹ã¦ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
        var roomId = '{{ room_id }}';
        downloadAllBtn.on('click', function () {
            window.location.href = `/download/all/${roomId}`;
        });
    });
</script>
{% endblock %}