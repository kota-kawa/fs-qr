{% extends "layout.html" %}
{% import "macros/icons.html" as icons %}

{% block meta_robots %}noindex, nofollow{% endblock %}
{% block meta_googlebot %}noindex, nofollow{% endblock %}

{% block page_title %}ファイル情報 | FS!QR - アップロード完了{% endblock %}

{% block meta_description %}FS!QRファイルアップロード完了。QRコードとダウンロードリンクが生成されました。ファイルを安全に共有・管理できます。{% endblock %}

{% block meta_keywords %}ファイル情報, アップロード完了, QRコード生成, ダウンロードリンク, ファイル共有完了, FS QR{% endblock %}

{% block og_title %}ファイル情報 | FS!QR - アップロード完了{% endblock %}

{% block og_description %}FS!QRファイルアップロード完了。QRコードとダウンロードリンクが生成されました。ファイルを安全に共有・管理できます。{% endblock %}

{% block twitter_title %}ファイル情報 | FS!QR{% endblock %}

{% block twitter_description %}ファイルアップロード完了。QRコードとダウンロードリンクが生成されました。{% endblock %}

{% block contents %}

<style>
/* Override colors for upload_complete and download pages to match fs-qr menu page */
.info-box-header {
  background: linear-gradient(135deg, #23c3df 0%, #1f27c7 100%) !important;
}

.share-url-wrapper {
  display: inline-flex;
  align-items: center;
  gap: 0.75rem;
  flex-wrap: wrap;
}

.share-url-link {
  color: inherit;
  text-decoration: none;
  word-break: break-all;
}

.share-url-link:hover,
.share-url-link:focus {
  color: inherit;
  text-decoration: none;
}

.copy-url-button {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 2.5rem;
  height: 2.5rem;
  padding: 0;
  border-radius: 999px;
  border: none;
  background: linear-gradient(135deg, #1f27c7 0%, #23c3df 100%);
  color: #fff;
  cursor: pointer;
  transition: transform 0.2s ease, box-shadow 0.2s ease, background 0.2s ease;
}

.copy-url-button svg {
  width: 1.25rem;
  height: 1.25rem;
  flex: none;
}

.copy-url-button:hover,
.copy-url-button:focus-visible {
  transform: translateY(-1px);
  box-shadow: 0 10px 15px -8px rgba(31, 39, 199, 0.5);
}

.copy-url-button:active {
  transform: translateY(0);
}

.copy-url-button.copied {
  background: linear-gradient(135deg, #1e40af 0%, #2563eb 100%);
}
</style>

<div class="info-page">
  <div class="info-box">
    <div class="info-box-header">
      <h2>
        <!-- タイトル -->
        {% if mode == 'upload' %}
        アップロード完了
        {% else %}
        ダウンロードできます
        {% endif %}
      </h2>
    </div>

    
    {% if mode == 'upload' %}
    <div class="info-box-content">
      <div class="text-center" style="max-width: 500px; margin: 0 auto;">
        <h3>ダウンロード先の情報:</h3>
        <table class="table table-bordered table-striped text-start">
          <tr>
            <th scope="row" class="text-center">ID</th>
            <td>{{ id | e }}</td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">パスワード</th>
            <td>{{ password | e }}</td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">共有リンク</th>
            <td>
              <div class="share-url-wrapper">
                <a id="shareRoomUrl" class="share-url-link" href="{{ url }}" target="_blank" rel="noopener">{{ url }}</a>
                <button
                  type="button"
                  class="copy-url-button"
                  data-copy-target="shareRoomUrl"
                  data-default-label="URLをコピー"
                  data-copied-label="コピー済み"
                  aria-label="URLをコピー"
                  title="URLをコピー"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" aria-hidden="true">
                    <path fill="currentColor" d="M16 1H4a2 2 0 0 0-2 2v12h2V3h12V1Zm4 4H8a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7a2 2 0 0 0-2-2Zm0 16H8V7h12v14Z"/>
                  </svg>
                </button>
              </div>
            </td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">ファイル名</th>
            <td>{{ secure_id }}.zip</td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">自動削除まで</th>
            <td>
              {{ retention_days }}日後
              <small class="text-muted d-block">選択した期間を過ぎると安全に削除されます。</small>
            </td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">削除予定日</th>
            <td>
              {% if deletion_date %}
                {{ deletion_date }}
              {% else %}
                {{ retention_days }}日後に自動削除予定
              {% endif %}
            </td>
          </tr>
        </table>

        <div class="text-center mt-4">
          <img src="https://api.qrserver.com/v1/create-qr-code?size=200x200&data={{ url | urlencode }}"
               class="img-fluid" style="max-width: 200px; height: auto; border-radius: 12px; box-shadow: var(--shadow-md);" alt="QR">
        </div>
        
        <div class="text-center mt-4">
          <a href="/fs-qr" class="modern-btn modern-btn-success">→他のファイルをアップロード</a>
        </div>
      </div>
    </div>


    {% else %}
    <div class="info-box-content">
      <div class="text-center" style="max-width: 400px; margin: 0 auto;">
        <table class="table table-bordered table-striped">
          <tr>
            <th scope="row" class="text-center">ID</th>
            <td class="text-start">{{ id | e }}</td>
          </tr>
          <tr>
            <th scope="row" class="text-center">ファイル名</th>
            <td class="text-start">{{ secure_id }}.zip</td>
          </tr>
          {% if password %}
          <tr>
            <th scope="row" class="text-center">Password</th>
            <td class="text-start">{{ password | e }}</td>
          </tr>
          {% endif %}
          <tr>
            <th scope="row" class="text-center">自動削除まで</th>
            <td class="text-start">{{ retention_days }}日後に削除予定</td>
          </tr>
          <tr>
            <th scope="row" class="text-center">削除予定日</th>
            <td class="text-start">
              {% if deletion_date %}
                {{ deletion_date }}
              {% else %}
                {{ retention_days }}日後に自動削除予定
              {% endif %}
            </td>
          </tr>
        </table>

        <form id="downloadForm" action="{{ url }}" method="POST" class="mt-4 text-center">
          <button type="submit" class="modern-btn modern-btn-success">ダウンロード</button>
        </form>
        
        <div class="text-center mt-4">
          <a href="/fs-qr" class="modern-btn">→他のファイルをアップロード</a>
        </div>
      </div>
    </div>

    {% endif %}
</div>

  <!-- Hidden elements for download functionality -->
  <div id="fileContent"></div>

  <script>
    async function copyTextToClipboard(text) {
      if (navigator.clipboard && window.isSecureContext) {
        return navigator.clipboard.writeText(text);
      }

      return new Promise((resolve, reject) => {
        const textarea = document.createElement('textarea');
        textarea.value = text;
        textarea.style.position = 'fixed';
        textarea.style.opacity = '0';
        document.body.appendChild(textarea);
        textarea.focus();
        textarea.select();

        try {
          if (document.execCommand('copy')) {
            resolve();
          } else {
            reject(new Error('execCommand failed'));
          }
        } catch (err) {
          reject(err);
        } finally {
          document.body.removeChild(textarea);
        }
      });
    }

    document.addEventListener('DOMContentLoaded', function () {
      document.querySelectorAll('.copy-url-button').forEach((button) => {
        button.addEventListener('click', async () => {
          const targetId = button.getAttribute('data-copy-target');
          const target = targetId ? document.getElementById(targetId) : null;
          if (!target) {
            return;
          }

          const text = target.textContent.trim();
          const defaultLabel = button.getAttribute('data-default-label') || 'コピー';
          const copiedLabel = button.getAttribute('data-copied-label') || 'コピー済み';
          if (!button.hasAttribute('aria-label')) {
            button.setAttribute('aria-label', defaultLabel);
          }
          if (!button.hasAttribute('title')) {
            button.setAttribute('title', defaultLabel);
          }

          try {
            await copyTextToClipboard(text);
            button.classList.add('copied');
            button.setAttribute('aria-label', copiedLabel);
            button.setAttribute('title', copiedLabel);
            setTimeout(() => {
              button.classList.remove('copied');
              button.setAttribute('aria-label', defaultLabel);
              button.setAttribute('title', defaultLabel);
            }, 2000);
          } catch (error) {
            alert('コピーに失敗しました。URLを選択して手動でコピーしてください。');
          }
        });
      });
    });
  </script>

  <!-- ▼ ダウンロード中の進捗を示すスピナー（非表示で用意しておく） -->
  <div class="spinner-container" id="spinnerContainer" style="display: none;">
    <div class="spinner-second-container" id="animationContainer">
      <div class="icon lock">{{ icons.icon('lock', extra_classes='svg-icon--spinner') }}</div>
      <div class="icon file">{{ icons.icon('document', extra_classes='svg-icon--spinner') }}</div>
      <div class="text" id="statusText">受信中...</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>

  <!-- Usage Section -->
  <div class="usage-section">
    <div class="usage-section-header">
      <h5>使い方</h5>
    </div>
    <div class="usage-section-content">
      <p>
        1. 上に表示されたIDとパスワード、共有リンクを共有したい相手に伝えてください。<br>
        2. 受け取った人はトップページの検索アイコンからIDとパスワードを入力するか、共有リンクを開くだけでファイルをダウンロードできます。<br>
        3. QRコードを読み取ればURLを直接開くことも可能です。<br>
        ファイルは一定期間後に自動で削除されるため、必要なときに早めにダウンロードしてください。
      </p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script>
    const container = document.getElementById('animationContainer');
    const spinnerContainer = document.getElementById('spinnerContainer');
    const progressBar = document.getElementById('progressBar');

    // アニメーションを1秒ごとにトグルさせる
    setInterval(() => {
      container.classList.toggle('decrypting');
    }, 1000); // 1秒ごとにトグル


    const downloadForm = document.getElementById('downloadForm');
    if (!downloadForm) {
      return;
    }

    downloadForm.addEventListener('submit', async function (e) {
    e.preventDefault(); // ← 従来のsubmitを止めて、JSの処理に切り替える

    // スピナーの表示
    const spinnerContainer = document.getElementById('spinnerContainer');
    const container = document.getElementById('animationContainer');
    spinnerContainer.style.display = 'flex';
    container.classList.add('decrypting');
    document.getElementById('statusText').textContent = '受信中...';

    // テンプレートからキーとなる文字列を取得
    const secureId = "{{ secure_id }}";
    const decryptionKey = secureId.split('-')[0];

    // fetch APIでサーバーからファイルを受信
    const response = await fetch(this.action, {
      method: 'POST'
    });
    const encryptedBlob = await response.blob();
    
    // レスポンスヘッダーからファイルタイプを取得
    const fileType = response.headers.get('X-File-Type') || 'multiple';
    const originalFilename = response.headers.get('X-Original-Filename') || '';

    // 状態を「復号中」に変更
    document.getElementById('statusText').textContent = '復号中...';

    let decryptedBlob;
    let downloadFilename;

    if (fileType === 'single') {
      // 単一ファイルの復号処理
      decryptedBlob = await decryptSingleFile(encryptedBlob, decryptionKey);
      downloadFilename = originalFilename || `${secureId}_decrypted`;
    } else {
      // 複数ファイル（ZIP）の復号処理
      decryptedBlob = await decryptAndDownloadZip(encryptedBlob, decryptionKey);
      downloadFilename = `${secureId}.zip`;
    }

    if (decryptedBlob) {
      // 復号完了後、自動ダウンロード
      const link = document.createElement('a');
      link.href = URL.createObjectURL(decryptedBlob);
      link.download = downloadFilename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert('復号に失敗しました。');
    }

    // スピナーを非表示に戻す
    spinnerContainer.style.display = 'none';
    container.classList.remove('decrypting');
  });

  // AES-GCMで復号する関数
  async function decryptFile(encryptedBuffer, key, iv) {
    const keyBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(key));
    const cryptoKey = await crypto.subtle.importKey(
      'raw',
      keyBuffer,
      { name: 'AES-GCM' },
      false,
      ['decrypt']
    );
    try {
      return await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, cryptoKey, encryptedBuffer);
    } catch (error) {
      console.error('復号エラー:', error);
      return null;
    }
  }

  // 単一ファイルの復号処理
  async function decryptSingleFile(encryptedBlob, key) {
    try {
      const arrayBuffer = await encryptedBlob.arrayBuffer();
      const iv = arrayBuffer.slice(0, 12);  // 最初の12バイトはIV
      const encryptedContent = arrayBuffer.slice(12);  // 残りが暗号化されたデータ
      
      const decryptedContent = await decryptFile(encryptedContent, key, iv);
      
      if (decryptedContent) {
        return new Blob([decryptedContent]);
      }
      return null;
    } catch (error) {
      console.error('単一ファイル復号エラー:', error);
      return null;
    }
  }

  // ZIPファイル内の各ファイルを復号 → 新たにZIP化 → 最終Blobを返す
  async function decryptAndDownloadZip(encryptedBlob, key) {
    const zip = await JSZip.loadAsync(encryptedBlob);
    const decryptedZip = new JSZip();
    const totalFiles = Object.keys(zip.files).length;
    let processedFiles = 0;

    for (const fileName in zip.files) {
      const fileData = await zip.file(fileName).async('arraybuffer');
      const iv = fileData.slice(0, 12);
      const encryptedContent = fileData.slice(12);
      const decryptedContent = await decryptFile(encryptedContent, key, iv);

      if (decryptedContent) {
        decryptedZip.file(fileName.replace('.enc', ''), decryptedContent);
      } else {
        return null;
      }

      // プログレスバーの更新例
      processedFiles++;
      const progressPercentage = (processedFiles / totalFiles) * 100;
      document.getElementById('progressBar').style.transform =
        `scaleX(${progressPercentage / 100})`;
    }

    return decryptedZip.generateAsync({ type: 'blob' });
  }




  </script>

  <style>
    /* 画面中央にスピナーを配置するためのスタイル */
    .spinner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 9999;
    }

    .spinner-second-container {
      position: relative;
      width: 200px;
      height: 200px;
    }

    .icon {
      font-size: 150px;
      transition: all 0.8s ease-in-out;
    }

    .lock {
      color: #e74c3c;
      position: absolute;
      top: 0;
      left: 0;
      transform: scale(1);
    }

    .file {
      color: #3498db;
      position: absolute;
      top: 0;
      left: 0;
      transform: scale(0);
      opacity: 0;
    }

    .decrypting .lock {
      transform: scale(1.5) rotate(-360deg);
      opacity: 0;
    }

    .decrypting .file {
      transform: scale(1);
      opacity: 1;
    }

    .text {
      position: absolute;
      bottom: -70px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      background: linear-gradient(90deg, #e74c3c, #3498db, #f1c40f, #9b59b6);
      background-size: 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: colorChange 2s linear infinite;
    }

    @keyframes colorChange {
      0% {
        background-position: 0%;
      }

      100% {
        background-position: 200%;
      }
    }

    .progress-bar-container {
      position: absolute;
      bottom: -30px;
      width: 100%;
      height: 10px;
      background-color: #ccc;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar {
      width: 100%;
      height: 100%;
      background-color: #3498db;
      transform-origin: left;
      /* 左端を基準に */
      transform: scaleX(0);
      /* 初期状態ではバーが0% */
      transition: transform 0.2s ease-in-out;
      /* 徐々に伸びる */
    }
  </style>
{% endblock %}