{% extends "layout.html" %}

{% block page_title %}ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± | FS!QR - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†{% endblock %}

{% block meta_description %}FS!QRãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚QRã‚³ãƒ¼ãƒ‰ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«å…±æœ‰ãƒ»ç®¡ç†ã§ãã¾ã™ã€‚{% endblock %}

{% block meta_keywords %}ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ±, ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†, QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ, ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯, ãƒ•ã‚¡ã‚¤ãƒ«å…±æœ‰å®Œäº†, FS QR{% endblock %}

{% block og_title %}ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± | FS!QR - ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†{% endblock %}

{% block og_description %}FS!QRãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚QRã‚³ãƒ¼ãƒ‰ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å®‰å…¨ã«å…±æœ‰ãƒ»ç®¡ç†ã§ãã¾ã™ã€‚{% endblock %}

{% block twitter_title %}ãƒ•ã‚¡ã‚¤ãƒ«æƒ…å ± | FS!QR{% endblock %}

{% block twitter_description %}ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†ã€‚QRã‚³ãƒ¼ãƒ‰ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ãƒªãƒ³ã‚¯ãŒç”Ÿæˆã•ã‚Œã¾ã—ãŸã€‚{% endblock %}

{% block contents %}

<style>
/* Override colors for upload_complete and download pages to match fs-qr menu page */
.info-box-header {
  background: linear-gradient(135deg, #23c3df 0%, #1f27c7 100%) !important;
}
</style>

<div class="info-page">
  <div class="info-box">
    <div class="info-box-header">
      <h2>
        <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
        {% if mode == 'upload' %}
        ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
        {% else %}
        ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
        {% endif %}
      </h2>
    </div>

    
    {% if mode == 'upload' %}
    <div class="info-box-content">
      <div class="text-center" style="max-width: 500px; margin: 0 auto;">
        <h3>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆã®æƒ…å ±:</h3>
        <table class="table table-bordered table-striped text-start">
          <tr>
            <th scope="row" class="text-center">ID</th>
            <td>{{ id | e }}</td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th>
            <td>{{ password | e }}</td>
          </tr>
          <tr>
            <th scope="row" class="text-center" style="white-space: nowrap;">ãƒ•ã‚¡ã‚¤ãƒ«å</th>
            <td>{{ secure_id }}.zip</td>
          </tr>
        </table>

        <div class="text-center mt-4">
          <img src="https://api.qrserver.com/v1/create-qr-code?size=200x200&data={{ url | urlencode }}"
               class="img-fluid" style="max-width: 200px; height: auto; border-radius: 12px; box-shadow: var(--shadow-md);" alt="QR">
        </div>
        
        <div class="text-center mt-4">
          <a href="/fs-qr" class="modern-btn modern-btn-success">â†’ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
        </div>
      </div>
    </div>


    {% else %}
    <div class="info-box-content">
      <div class="text-center" style="max-width: 400px; margin: 0 auto;">
        <table class="table table-bordered table-striped">
          <tr>
            <th scope="row" class="text-center">ID</th>
            <td class="text-start">{{ id | e }}</td>
          </tr>
          <tr>
            <th scope="row" class="text-center">ãƒ•ã‚¡ã‚¤ãƒ«å</th>
            <td class="text-start">{{ secure_id }}.zip</td>
          </tr>
        </table>

        <form id="downloadForm" action="{{ url }}" method="POST" class="mt-4 text-center">
          <button type="submit" class="modern-btn modern-btn-success">ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰</button>
        </form>
        
        <div class="text-center mt-4">
          <a href="/fs-qr" class="modern-btn">â†’ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a>
        </div>
      </div>
    </div>

    {% endif %}
  </div>

  <!-- Hidden elements for download functionality -->
  <div id="fileContent"></div>
  
  <!-- â–¼ ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ä¸­ã®é€²æ—ã‚’ç¤ºã™ã‚¹ãƒ”ãƒŠãƒ¼ï¼ˆéè¡¨ç¤ºã§ç”¨æ„ã—ã¦ãŠãï¼‰ -->
  <div class="spinner-container" id="spinnerContainer" style="display: none;">
    <div class="spinner-second-container" id="animationContainer">
      <div class="icon lock">ğŸ”’</div>
      <div class="icon file">ğŸ“„</div>
      <div class="text" id="statusText">å—ä¿¡ä¸­...</div>
      <div class="progress-bar-container">
        <div class="progress-bar" id="progressBar"></div>
      </div>
    </div>
  </div>

  <!-- Usage Section -->
  <div class="usage-section">
    <div class="usage-section-header">
      <h5>ä½¿ã„æ–¹</h5>
    </div>
    <div class="usage-section-content">
      <p>
        1. ä¸Šã«è¡¨ç¤ºã•ã‚ŒãŸIDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…±æœ‰ã—ãŸã„ç›¸æ‰‹ã«ä¼ãˆã¦ãã ã•ã„ã€‚<br>
        2. å—ã‘å–ã£ãŸäººã¯ãƒˆãƒƒãƒ—ãƒšãƒ¼ã‚¸ã®æ¤œç´¢ã‚¢ã‚¤ã‚³ãƒ³ã‹ã‚‰IDã¨ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›ã™ã‚‹ã¨ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br>
        3. QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿å–ã‚Œã°URLã‚’ç›´æ¥é–‹ãã“ã¨ã‚‚å¯èƒ½ã§ã™ã€‚<br>
        ãƒ•ã‚¡ã‚¤ãƒ«ã¯ä¸€å®šæœŸé–“å¾Œã«è‡ªå‹•ã§å‰Šé™¤ã•ã‚Œã‚‹ãŸã‚ã€å¿…è¦ãªã¨ãã«æ—©ã‚ã«ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¦ãã ã•ã„ã€‚
      </p>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
  <script>
    const container = document.getElementById('animationContainer');
    const spinnerContainer = document.getElementById('spinnerContainer');
    const progressBar = document.getElementById('progressBar');

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ç§’ã”ã¨ã«ãƒˆã‚°ãƒ«ã•ã›ã‚‹
    setInterval(() => {
      container.classList.toggle('decrypting');
    }, 1000); // 1ç§’ã”ã¨ã«ãƒˆã‚°ãƒ«


    document.getElementById('downloadForm').addEventListener('submit', async function (e) {
    e.preventDefault(); // â† å¾“æ¥ã®submitã‚’æ­¢ã‚ã¦ã€JSã®å‡¦ç†ã«åˆ‡ã‚Šæ›¿ãˆã‚‹

    // ã‚¹ãƒ”ãƒŠãƒ¼ã®è¡¨ç¤º
    const spinnerContainer = document.getElementById('spinnerContainer');
    const container = document.getElementById('animationContainer');
    spinnerContainer.style.display = 'flex';
    container.classList.add('decrypting');
    document.getElementById('statusText').textContent = 'å—ä¿¡ä¸­...';

    // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‹ã‚‰ã‚­ãƒ¼ã¨ãªã‚‹æ–‡å­—åˆ—ã‚’å–å¾—
    const secureId = "{{ secure_id }}";
    const decryptionKey = secureId.split('-')[0];

    // fetch APIã§ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å—ä¿¡
    const response = await fetch(`/download_go/${secureId}`, {
      method: 'POST'
    });
    const encryptedBlob = await response.blob();
    
    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ˜ãƒƒãƒ€ãƒ¼ã‹ã‚‰ãƒ•ã‚¡ã‚¤ãƒ«ã‚¿ã‚¤ãƒ—ã‚’å–å¾—
    const fileType = response.headers.get('X-File-Type') || 'multiple';
    const originalFilename = response.headers.get('X-Original-Filename') || '';

    // çŠ¶æ…‹ã‚’ã€Œå¾©å·ä¸­ã€ã«å¤‰æ›´
    document.getElementById('statusText').textContent = 'å¾©å·ä¸­...';

    let decryptedBlob;
    let downloadFilename;

    if (fileType === 'single') {
      // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å·å‡¦ç†
      decryptedBlob = await decryptSingleFile(encryptedBlob, decryptionKey);
      downloadFilename = originalFilename || `${secureId}_decrypted`;
    } else {
      // è¤‡æ•°ãƒ•ã‚¡ã‚¤ãƒ«ï¼ˆZIPï¼‰ã®å¾©å·å‡¦ç†
      decryptedBlob = await decryptAndDownloadZip(encryptedBlob, decryptionKey);
      downloadFilename = `${secureId}.zip`;
    }

    if (decryptedBlob) {
      // å¾©å·å®Œäº†å¾Œã€è‡ªå‹•ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
      const link = document.createElement('a');
      link.href = URL.createObjectURL(decryptedBlob);
      link.download = downloadFilename;
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    } else {
      alert('å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
    }

    // ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éè¡¨ç¤ºã«æˆ»ã™
    spinnerContainer.style.display = 'none';
    container.classList.remove('decrypting');
  });

  // AES-GCMã§å¾©å·ã™ã‚‹é–¢æ•°
  async function decryptFile(encryptedBuffer, key, iv) {
    const keyBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(key));
    const cryptoKey = await crypto.subtle.importKey(
      'raw',
      keyBuffer,
      { name: 'AES-GCM' },
      false,
      ['decrypt']
    );
    try {
      return await crypto.subtle.decrypt({ name: 'AES-GCM', iv }, cryptoKey, encryptedBuffer);
    } catch (error) {
      console.error('å¾©å·ã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  }

  // å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å·å‡¦ç†
  async function decryptSingleFile(encryptedBlob, key) {
    try {
      const arrayBuffer = await encryptedBlob.arrayBuffer();
      const iv = arrayBuffer.slice(0, 12);  // æœ€åˆã®12ãƒã‚¤ãƒˆã¯IV
      const encryptedContent = arrayBuffer.slice(12);  // æ®‹ã‚ŠãŒæš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿
      
      const decryptedContent = await decryptFile(encryptedContent, key, iv);
      
      if (decryptedContent) {
        return new Blob([decryptedContent]);
      }
      return null;
    } catch (error) {
      console.error('å˜ä¸€ãƒ•ã‚¡ã‚¤ãƒ«å¾©å·ã‚¨ãƒ©ãƒ¼:', error);
      return null;
    }
  }

  // ZIPãƒ•ã‚¡ã‚¤ãƒ«å†…ã®å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å· â†’ æ–°ãŸã«ZIPåŒ– â†’ æœ€çµ‚Blobã‚’è¿”ã™
  async function decryptAndDownloadZip(encryptedBlob, key) {
    const zip = await JSZip.loadAsync(encryptedBlob);
    const decryptedZip = new JSZip();
    const totalFiles = Object.keys(zip.files).length;
    let processedFiles = 0;

    for (const fileName in zip.files) {
      const fileData = await zip.file(fileName).async('arraybuffer');
      const iv = fileData.slice(0, 12);
      const encryptedContent = fileData.slice(12);
      const decryptedContent = await decryptFile(encryptedContent, key, iv);

      if (decryptedContent) {
        decryptedZip.file(fileName.replace('.enc', ''), decryptedContent);
      } else {
        return null;
      }

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°ä¾‹
      processedFiles++;
      const progressPercentage = (processedFiles / totalFiles) * 100;
      document.getElementById('progressBar').style.transform =
        `scaleX(${progressPercentage / 100})`;
    }

    return decryptedZip.generateAsync({ type: 'blob' });
  }




  </script>

  <style>
    /* ç”»é¢ä¸­å¤®ã«ã‚¹ãƒ”ãƒŠãƒ¼ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
    .spinner-container {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
      background-color: rgba(255, 255, 255, 0.8);
      z-index: 9999;
    }

    .spinner-second-container {
      position: relative;
      width: 200px;
      height: 200px;
    }

    .icon {
      font-size: 150px;
      transition: all 0.8s ease-in-out;
    }

    .lock {
      color: #e74c3c;
      position: absolute;
      top: 0;
      left: 0;
      transform: scale(1);
    }

    .file {
      color: #3498db;
      position: absolute;
      top: 0;
      left: 0;
      transform: scale(0);
      opacity: 0;
    }

    .decrypting .lock {
      transform: scale(1.5) rotate(-360deg);
      opacity: 0;
    }

    .decrypting .file {
      transform: scale(1);
      opacity: 1;
    }

    .text {
      position: absolute;
      bottom: -70px;
      width: 100%;
      text-align: center;
      font-size: 20px;
      font-weight: bold;
      background: linear-gradient(90deg, #e74c3c, #3498db, #f1c40f, #9b59b6);
      background-size: 200%;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      animation: colorChange 2s linear infinite;
    }

    @keyframes colorChange {
      0% {
        background-position: 0%;
      }

      100% {
        background-position: 200%;
      }
    }

    .progress-bar-container {
      position: absolute;
      bottom: -30px;
      width: 100%;
      height: 10px;
      background-color: #ccc;
      border-radius: 5px;
      overflow: hidden;
    }

    .progress-bar {
      width: 100%;
      height: 100%;
      background-color: #3498db;
      transform-origin: left;
      /* å·¦ç«¯ã‚’åŸºæº–ã« */
      transform: scaleX(0);
      /* åˆæœŸçŠ¶æ…‹ã§ã¯ãƒãƒ¼ãŒ0% */
      transition: transform 0.2s ease-in-out;
      /* å¾ã€…ã«ä¼¸ã³ã‚‹ */
    }
  </style>
{% endblock %}