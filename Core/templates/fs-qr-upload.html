{% extends "layout.html" %}
{% block contents %}

<div class="modern-page-container">
    <div class="modern-content-card">
        <div class="modern-card-header">
            <h1>ğŸ“ ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</h1>
        </div>
        
        <div class="modern-card-body">
            <form action="/upload" method="POST" enctype="multipart/form-data" id="uploadForm">
                <!-- Upload Area -->
                <div class="modern-upload-area" id="upload-area">
                    <div class="upload-icon-modern">ğŸ“</div>
                    <p class="upload-text-modern">ã“ã“ã‚’ã‚¯ãƒªãƒƒã‚¯ã¾ãŸã¯ãƒ‰ãƒ©ãƒƒã‚°ã—ã¦ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</p>
                    <button type="button" onclick="fileInput.click()" class="upload-button-modern">
                        ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠ
                    </button>
                    <input type="file" name="upfile" id="fileInput" multiple style="display: none;">
                </div>
                
                <!-- File List -->
                <div class="modern-file-list" id="fileList" style="display: none;">
                </div>

                <!-- ID Input -->
                <div class="modern-form-group">
                    <label for="name" class="modern-form-label">å…±æœ‰ç”¨IDï¼ˆ5-10æ–‡å­—ï¼‰</label>
                    <input type="text" class="modern-form-input" minlength="5" maxlength="10" 
                           name="name" id="name" placeholder="å…±æœ‰ç”¨ã®IDã‚’å…¥åŠ›ã—ã¦ãã ã•ã„" required 
                           style="max-width: 300px;">
                </div>

                <!-- Submit Button -->
                <button type="submit" class="modern-btn modern-btn-success">
                    ğŸš€ ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é–‹å§‹
                </button>
            </form>
        </div>
    </div>

    <!-- Usage Section -->
    <div class="usage-section">
        <div class="usage-section-header">
            <h5>ä½¿ã„æ–¹</h5>
        </div>
        <div class="usage-section-content">
            <p>
                1. ä¸Šã®ã‚¨ãƒªã‚¢ã«ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã™ã‚‹ã‹ã€Œãƒ•ã‚¡ã‚¤ãƒ«ã‚’é¸æŠã€ã§è¿½åŠ ã—ã¾ã™ã€‚<br>
                2. å…±æœ‰ç”¨ã®IDã‚’å…¥åŠ›ã—ã¦ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã€ã‚’æŠ¼ã™ã¨ã€ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ä»˜ãã®ãƒ«ãƒ¼ãƒ ãŒä½œæˆã•ã‚Œã¾ã™ã€‚<br>
                3. å®Œäº†ç”»é¢ã«è¡¨ç¤ºã•ã‚Œã‚‹IDãƒ»ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã¨QRã‚³ãƒ¼ãƒ‰ã‚’ç›¸æ‰‹ã«ä¼ãˆã‚‹ã¨ã€åŒã˜ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™ã€‚<br>
                â€»10MBã¾ã§ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’æ‰±ãˆã¾ã™ã€‚ä¸€éƒ¨ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã§ããªã„ç¨®é¡ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚‚ã‚ã‚Šã¾ã™ã€‚
            </p>
        </div>
    </div>
</div>

<!-- Spinner Container (Hidden initially) -->
<div id="spinner-container" class="spinner-container" style="display:none;">
    <div class="spinner-second-container">
        <div class="icon file">ğŸ“„</div>
        <div class="icon lock">ğŸ”’</div>
        <div class="text">æš—å·åŒ–ä¸­...</div>
        <div class="progress-bar-container">
            <div class="progress-bar"></div>
        </div>
    </div>
</div>

<!-- JavaScript for Encryption, ZIP, Upload Area, and Spinner -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
<script>
    const uploadArea = document.getElementById('upload-area');
    const fileInput = document.getElementById('fileInput');
    const fileListDisplay = document.getElementById('fileList');
    const idInput = document.getElementById('name');
    const uploadForm = document.getElementById('uploadForm');

    // ãƒ‰ãƒ©ãƒƒã‚°ï¼†ãƒ‰ãƒ­ãƒƒãƒ—ã‚’æœ‰åŠ¹ã«ã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆ
    uploadArea.addEventListener('dragover', (e) => {
        e.preventDefault();
        uploadArea.classList.add('dragover');
    });

    uploadArea.addEventListener('dragleave', () => {
        uploadArea.classList.remove('dragover');
    });

    uploadArea.addEventListener('drop', (e) => {
        e.preventDefault();
        uploadArea.classList.remove('dragover');
        const files = e.dataTransfer.files;
        console.log('Files dropped:', files);
        handleFiles(files);
    });

    fileInput.addEventListener('change', (e) => {
        const files = e.target.files;
        console.log('Files selected:', files);
        handleFiles(files);
    });

    function handleFiles(files) {
        // ãƒ•ã‚¡ã‚¤ãƒ«æ•°åˆ¶é™ãƒã‚§ãƒƒã‚¯
        const MAX_FILES = 10;
        if (files.length > MAX_FILES) {
            alert(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯æœ€å¤§${MAX_FILES}å€‹ã¾ã§ã§ã™`);
            return;
        }

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚µã‚¤ã‚ºåˆ¶é™ãƒã‚§ãƒƒã‚¯ (50MB = 50 * 1024 * 1024 bytes)
        const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB
        let totalSize = 0;
        Array.from(files).forEach(file => {
            totalSize += file.size;
        });
        
        if (totalSize > MAX_TOTAL_SIZE) {
            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯50MBã¾ã§ã§ã™ï¼ˆç¾åœ¨: ${sizeMB}MBï¼‰`);
            return;
        }

        fileListDisplay.innerHTML = ''; // ãƒªã‚¹ãƒˆã‚’ã‚¯ãƒªã‚¢
        fileListDisplay.style.display = 'block'; // Show file list
        
        Array.from(files).forEach((file, index) => {
            const fileItem = document.createElement('div');
            fileItem.className = 'modern-file-item';
            
            const fileName = document.createElement('div');
            fileName.className = 'modern-file-name';
            fileName.innerHTML = `<span class="modern-file-icon">ğŸ“„</span>${file.name}`;
            
            const fileActions = document.createElement('div');
            fileActions.className = 'modern-file-actions';
            
            const deleteBtn = document.createElement('button');
            deleteBtn.className = 'modern-file-action-btn delete';
            deleteBtn.innerHTML = 'ğŸ—‘ï¸';
            deleteBtn.type = 'button';
            deleteBtn.onclick = () => {
                fileItem.remove();
                if (fileListDisplay.children.length === 0) {
                    fileListDisplay.style.display = 'none';
                    document.querySelector('.upload-icon-modern').textContent = 'ğŸ“';
                }
            };
            
            fileActions.appendChild(deleteBtn);
            fileItem.appendChild(fileName);
            fileItem.appendChild(fileActions);
            fileListDisplay.appendChild(fileItem);
        });
        
        document.querySelector('.upload-icon-modern').textContent = 'âœ…';

        // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’fileInputã«ã‚»ãƒƒãƒˆã™ã‚‹
        const dataTransfer = new DataTransfer();
        Array.from(files).forEach(file => {
            dataTransfer.items.add(file);
        });
        fileInput.files = dataTransfer.files;
    }

    // æš—å·åŒ–ã¨é€²æ—è¡¨ç¤ºã®é–¢æ•°
    async function encryptAndZipFilesWithProgress(files, key) {
        const zip = new JSZip();
        const keyBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(key));
        const cryptoKey = await crypto.subtle.importKey('raw', keyBuffer, { name: 'AES-GCM' }, false, ['encrypt']);

        const progressBar = document.querySelector('.progress-bar');

        // å„ãƒ•ã‚¡ã‚¤ãƒ«ã‚’é †æ¬¡å‡¦ç†
        for (let i = 0; i < files.length; i++) {
            const file = files[i];
            const iv = crypto.getRandomValues(new Uint8Array(12));
            const fileBuffer = await file.arrayBuffer();
            const encryptedBuffer = await crypto.subtle.encrypt({ name: 'AES-GCM', iv: iv }, cryptoKey, fileBuffer);
            zip.file(`${file.name}.enc`, new Blob([iv, encryptedBuffer]));
        }

        // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®ç”Ÿæˆã¨é€²æ—ãƒãƒ¼ã®æ›´æ–°
        return await zip.generateAsync({ type: 'blob' }, (metadata) => {
            const progressPercentage = metadata.percent.toFixed(2);
            progressBar.style.transform = `scaleX(${progressPercentage / 100})`;
        });
    }

    // 1ç§’ã”ã¨ã«è¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    let iconSwitchInterval;

    function startIconSwitching() {
        const spinnerContainer = document.querySelector('.spinner-second-container');
        iconSwitchInterval = setInterval(() => {
            spinnerContainer.classList.toggle('encrypting');
        }, 1000); // 1ç§’ã”ã¨ã«åˆ‡ã‚Šæ›¿ãˆ
    }

    function stopIconSwitching() {
        clearInterval(iconSwitchInterval);
    }

    // ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡æ™‚ã®ã‚¤ãƒ™ãƒ³ãƒˆä¿®æ­£
    uploadForm.addEventListener('submit', async function (event) {
    event.preventDefault(); // æ¨™æº–ã®ãƒ•ã‚©ãƒ¼ãƒ é€ä¿¡ã‚’æ­¢ã‚ã‚‹

    // ã‚¹ãƒ”ãƒŠãƒ¼è¡¨ç¤º & ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³é–‹å§‹
    document.getElementById('spinner-container').style.display = 'flex';
    startIconSwitching();

    const files = fileInput.files;
    const id = idInput.value.trim();

    if (files.length > 0 && id.length > 0) {
        // ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å‰ã«å†åº¦ãƒ•ã‚¡ã‚¤ãƒ«åˆ¶é™ã‚’ãƒã‚§ãƒƒã‚¯
        const MAX_FILES = 10;
        const MAX_TOTAL_SIZE = 50 * 1024 * 1024; // 50MB
        
        if (files.length > MAX_FILES) {
            alert(`ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã¯æœ€å¤§${MAX_FILES}å€‹ã¾ã§ã§ã™`);
            document.getElementById('spinner-container').style.display = 'none';
            stopIconSwitching();
            return;
        }
        
        let totalSize = 0;
        Array.from(files).forEach(file => {
            totalSize += file.size;
        });
        
        if (totalSize > MAX_TOTAL_SIZE) {
            const sizeMB = (totalSize / (1024 * 1024)).toFixed(2);
            alert(`ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆè¨ˆã‚µã‚¤ã‚ºã¯50MBã¾ã§ã§ã™ï¼ˆç¾åœ¨: ${sizeMB}MBï¼‰`);
            document.getElementById('spinner-container').style.display = 'none';
            stopIconSwitching();
            return;
        }
        
        try {
            // (1)ã€Œã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...ã€ã‚’è¡¨ç¤º â€»æœ€ä½1ç§’ã¯è¡¨ç¤º
            document.querySelector('.text').textContent = 'ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ä¸­...';
            await new Promise(resolve => setTimeout(resolve, 1000));

            // (2) æš—å·åŒ–å‡¦ç†ã«å…¥ã‚‹
            document.querySelector('.text').textContent = 'æš—å·åŒ–ä¸­...';
            const zipBlob = await encryptAndZipFilesWithProgress(files, id);

            // æš—å·åŒ–å®Œäº†â†’ é€ä¿¡é–‹å§‹ã®å‰ã«é€²æ—ãƒãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
            const progressBar = document.querySelector('.progress-bar');
            progressBar.style.transform = 'scaleX(0)';

            // (3) é€ä¿¡ä¸­ã«åˆ‡ã‚Šæ›¿ãˆ
            document.querySelector('.text').textContent = 'é€ä¿¡ä¸­...';

            // é€ä¿¡ã™ã‚‹ãƒ•ã‚¡ã‚¤ãƒ«ã‚’FormDataã«è¿½åŠ 
            const zipFile = new File([zipBlob], 'encrypted_files.zip', { type: 'application/zip' });
            const formData = new FormData();
            formData.append('upfile', zipFile);
            formData.append('name', id);

            // XMLHttpRequest ã‚’åˆ©ç”¨ã—ã¦ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰é€²æ—ã‚’è¨ˆæ¸¬
            const xhr = new XMLHttpRequest();
            xhr.open('POST', '/upload', true);

            xhr.upload.onprogress = function (event) {
                if (event.lengthComputable) {
                    const progressPercentage = (event.loaded / event.total) * 100;
                    // é€ä¿¡é€²æ—ã«åˆã‚ã›ã¦ãƒãƒ¼ã‚’æ›´æ–°
                    progressBar.style.transform = `scaleX(${progressPercentage / 100})`;
                }
            };

            xhr.onload = function () {
                if (xhr.status === 200) {
                    const result = JSON.parse(xhr.responseText);
                    if (result.redirect_url) {
                        window.location.href = result.redirect_url;
                    } else {
                        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ(ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆURLãŒã‚ã‚Šã¾ã›ã‚“)');
                    }
                } else {
                    // Handle JSON error responses
                    try {
                        const errorResult = JSON.parse(xhr.responseText);
                        if (errorResult.error) {
                            alert('ã‚¨ãƒ©ãƒ¼: ' + errorResult.error);
                        } else {
                            alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ(ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼)');
                        }
                    } catch (e) {
                        alert('ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã«å¤±æ•—ã—ã¾ã—ãŸ(ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼)');
                    }
                }
                stopIconSwitching();
            };

            xhr.onerror = function () {
                alert('é€ä¿¡ä¸­ã«ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ');
                stopIconSwitching();
            };

            // é€ä¿¡é–‹å§‹
            xhr.send(formData);

        } catch (error) {
            alert('ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: ' + error.message);
            stopIconSwitching();
        }
    } else {
        alert('ãƒ•ã‚¡ã‚¤ãƒ«ã¨IDã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚');
        stopIconSwitching();
    }
});

</script>
{% endblock %}