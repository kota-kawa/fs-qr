{% extends "layout.html" %}
{% block contents %}
<div class="content">
  <h2>

    <!-- ã‚¿ã‚¤ãƒˆãƒ« -->
    {% if mode == 'upload' %}
    ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰å®Œäº†
    {% else %}
    ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã§ãã¾ã™
    {% endif %}

  </h2>




  {% if mode == 'upload' %}



  <div align="center" class="box-noborder">
    <p>ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å…ˆã®æƒ…å ±:</p>
    <table class="pure-table pure-table-bordered">

      <tr>
        <th>ID</th>
        <td>{{ id }}</td>
      </tr>

      <tr>
        <th>ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</th>
        <td>{{ password }}</td>
      </tr>

      <tr>
        <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
        <td>{{ secure_id }}.zip</td>
      </tr>


    </table>

    <div align="center">
      <a>
        <img src="/static/qrcode/qrcode-{{ secure_id }}.jpg" width="350" height="350">
      </a>
    </div>

  </div>


  {% else %}
  <div align="center" class="box-noborder">
    <table class="pure-table pure-table-bordered">
      <tr>
        <th>ID</th>
        <td>{{ id }}</td>
      </tr>
      <tr>
        <th>ãƒ•ã‚¡ã‚¤ãƒ«å</th>
        <td>{{ secure_id }}.zip</td>
      </tr>
    </table>
    <p>ã€€</p>
    <p>
    <form id="downloadForm" action="{{ url }}" method="POST" class="pure-form">
      </p>
      <input class="btn btn-success" type="submit" value="ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰">
    </form>
    <div id="fileContent"></div>

    <!-- ã‚¹ãƒ”ãƒŠãƒ¼ã‚’ã“ã“ã«æŒ¿å…¥ -->
    <div class="spinner-container" id="spinnerContainer" style="display: none;">
      <div class="spinner-second-container" id="animationContainer">
        <div class="icon lock">ğŸ”’</div>
        <div class="icon file">ğŸ“„</div>
        <div class="text">å¾©å·ä¸­...</div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar"></div>
        </div>
      </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>
    <script>
      const container = document.getElementById('animationContainer');
      const spinnerContainer = document.getElementById('spinnerContainer');
      const progressBar = document.getElementById('progressBar');

          // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ã‚’1ç§’ã”ã¨ã«ãƒˆã‚°ãƒ«ã•ã›ã‚‹
    setInterval(() => {
      container.classList.toggle('decrypting');
    }, 1000); // 1ç§’ã”ã¨ã«ãƒˆã‚°ãƒ«




      document.getElementById('downloadForm').addEventListener('submit', async function (e) {
        e.preventDefault();  // ãƒ•ã‚©ãƒ¼ãƒ ã®ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆé€ä¿¡ã‚’é˜²ã

        // ã‚¹ãƒ”ãƒŠãƒ¼ã‚’è¡¨ç¤º
        spinnerContainer.style.display = 'flex';
        container.classList.add('decrypting');

        const secureId = "{{ secure_id }}";  // ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆã‚¨ãƒ³ã‚¸ãƒ³ã‹ã‚‰æ¸¡ã•ã‚ŒãŸsecure_id
        const decryptionKey = secureId.split('-')[0];  // secure_idã®æœ€åˆã®ã€Œ-ã€ã¾ã§ã‚’ã‚­ãƒ¼ã¨ã—ã¦ä½¿ç”¨

        // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰å–å¾—
        const response = await fetch(`/download_go/${secureId}`, {
          method: 'POST'
        });
        const encryptedBlob = await response.blob();  // ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã®ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’blobã¨ã—ã¦å–å¾—

        // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å·å‡¦ç†ï¼ˆé€²æ—ãƒãƒ¼æ›´æ–°æ©Ÿèƒ½è¿½åŠ ï¼‰
        const decryptedBlob = await decryptAndDownloadZip(encryptedBlob, decryptionKey);
        if (decryptedBlob) {
          // å¾©å·ã•ã‚ŒãŸZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
          const link = document.createElement('a');
          link.href = URL.createObjectURL(decryptedBlob);
          link.download = `${secureId}.zip`;  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰åã‚’è¨­å®š
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);  // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å¾Œãƒªãƒ³ã‚¯ã‚’å‰Šé™¤
        } else {
          alert('å¾©å·ã«å¤±æ•—ã—ã¾ã—ãŸã€‚');
        }

        // ã‚¹ãƒ”ãƒŠãƒ¼ã‚’éè¡¨ç¤ºã«æˆ»ã™
        spinnerContainer.style.display = 'none';
        container.classList.remove('decrypting');
      });

      // AES-GCMã§ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·
      async function decryptFile(encryptedBuffer, key, iv) {
        const keyBuffer = await crypto.subtle.digest('SHA-256', new TextEncoder().encode(key));  // secure_idã‹ã‚‰éµç”Ÿæˆ
        const cryptoKey = await crypto.subtle.importKey('raw', keyBuffer, { name: 'AES-GCM' }, false, ['decrypt']);

        try {
          const decryptedBuffer = await crypto.subtle.decrypt({ name: 'AES-GCM', iv: iv }, cryptoKey, encryptedBuffer);
          return decryptedBuffer;
        } catch (error) {
          console.error('å¾©å·ã‚¨ãƒ©ãƒ¼:', error);
          return null;
        }
      }

      // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã®å¾©å·ã¨ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰å‡¦ç†
      async function decryptAndDownloadZip(encryptedBlob, key) {
        const zip = await JSZip.loadAsync(encryptedBlob);  // ZIPãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã¿
        const decryptedZip = new JSZip();
        const totalFiles = Object.keys(zip.files).length;  // ç·ãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’å–å¾—
        let processedFiles = 0;  // å‡¦ç†ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«æ•°ã‚’ãƒˆãƒ©ãƒƒã‚­ãƒ³ã‚°

        for (const fileName in zip.files) {
          const fileData = await zip.file(fileName).async('arraybuffer');  // æš—å·åŒ–ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ArrayBufferã§å–å¾—
          const iv = fileData.slice(0, 12);  // æœ€åˆã®12ãƒã‚¤ãƒˆã¯IV
          const encryptedContent = fileData.slice(12);  // IVä»¥é™ãŒæš—å·åŒ–ã•ã‚ŒãŸãƒ‡ãƒ¼ã‚¿

          const decryptedContent = await decryptFile(encryptedContent, key, iv);  // ãƒ•ã‚¡ã‚¤ãƒ«ã‚’å¾©å·
          if (decryptedContent) {
            decryptedZip.file(fileName.replace('.enc', ''), decryptedContent);  // å¾©å·ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«ã‚’ZIPã«è¿½åŠ 
          } else {
            return null;
          }

          // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®æ›´æ–°
          processedFiles += 1;
          const progressPercentage = (processedFiles / totalFiles) * 100;
          progressBar.style.transform = `scaleX(${1 - (progressPercentage / 100)})`;  // å³ã‹ã‚‰å·¦ã¸é€²ã‚€
        }

        return decryptedZip.generateAsync({ type: 'blob' });  // å¾©å·ã•ã‚ŒãŸZIPã‚’ç”Ÿæˆ
      }




    </script>

    <style>
      /* ç”»é¢ä¸­å¤®ã«ã‚¹ãƒ”ãƒŠãƒ¼ã‚’é…ç½®ã™ã‚‹ãŸã‚ã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .spinner-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        justify-content: center;
        align-items: center;
        background-color: rgba(255, 255, 255, 0.8);
        z-index: 9999;
      }

      .spinner-second-container {
        position: relative;
        width: 200px;
        height: 200px;
      }

      .icon {
        font-size: 150px;
        transition: all 0.8s ease-in-out;
      }

      .lock {
        color: #e74c3c;
        position: absolute;
        top: 0;
        left: 0;
        transform: scale(1);
      }

      .file {
        color: #3498db;
        position: absolute;
        top: 0;
        left: 0;
        transform: scale(0);
        opacity: 0;
      }

      .decrypting .lock {
        transform: scale(1.5) rotate(-360deg);
        opacity: 0;
      }

      .decrypting .file {
        transform: scale(1);
        opacity: 1;
      }

      .text {
        position: absolute;
        bottom: -70px;
        width: 100%;
        text-align: center;
        font-size: 20px;
        font-weight: bold;
        background: linear-gradient(90deg, #e74c3c, #3498db, #f1c40f, #9b59b6);
        background-size: 200%;
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        animation: colorChange 2s linear infinite;
      }

      @keyframes colorChange {
        0% {
          background-position: 0%;
        }

        100% {
          background-position: 200%;
        }
      }

      .progress-bar-container {
        position: absolute;
        bottom: -30px;
        width: 100%;
        height: 10px;
        background-color: #e74c3c;
        border-radius: 5px;
        overflow: hidden;
      }

      .progress-bar {
        width: 100%;
        height: 100%;

        background-color: #ccc;
        transform-origin: right;
        /* å³ç«¯ã‚’åŸºæº–ã« */
        transform: scaleX(1);
        /* åˆæœŸçŠ¶æ…‹ã§ã¯ãƒãƒ¼ãŒ100% */
        transition: transform 0.2s ease-in-out;
        /* å¾ã€…ã«ç¸®ã‚€ */
      }
    </style>
  </div>




  {% endif %}


  <p><a href="/">â†’ä»–ã®ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰</a></p>
</div>
{% endblock %}